{"ast":null,"code":"import _objectSpread from\"D:/cn/phim/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect}from'react';import styles from'./RecommendationsPage.module.css';import{API_BASE}from'../config';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";export default function RecommendationsPage(_ref){let{onBack,initialMovie}=_ref;const[recType]=useState('hybrid');const[recommendations,setRecommendations]=useState([]);const[loading,setLoading]=useState(false);const[error,setError]=useState('');const[movieHistory,setMovieHistory]=useState([]);// Stack of viewed movies\nconst[similarMoviesCache,setSimilarMoviesCache]=useState({});// Cache similar movies by movie ID\nconst[likes,setLikes]=useState({});// Track liked movies\nconst[dislikes,setDislikes]=useState({});// Track disliked movies\nconst[reviewRating,setReviewRating]=useState(0);// Review rating (1-5)\nconst[comments,setComments]=useState([]);const[commentText,setCommentText]=useState('');const[showAllComments,setShowAllComments]=useState(false);const[hoverRating,setHoverRating]=useState(0);// Hover rating for preview\nconst currentMovie=movieHistory.length>0?movieHistory[movieHistory.length-1]:null;const similarMovies=currentMovie?similarMoviesCache[currentMovie.id]||[]:[];// Load initial movie if provided (from HomePage click)\nuseEffect(()=>{if(initialMovie){// If history is empty or last movie differs, open the initial movie\nconst last=movieHistory.length>0?movieHistory[movieHistory.length-1]:null;if(!last||last.id!==initialMovie.id){openMovie(initialMovie);}}},[initialMovie]);const getYouTubeEmbedUrl=url=>{if(!url)return null;// N·∫øu l√† embed URL, tr·∫£ v·ªÅ tr·ª±c ti·∫øp\nif(url.includes('/embed')){// N·∫øu backend tr·∫£ v·ªÅ URL embed, chuy·ªÉn hostname sang youtube-nocookie ƒë·ªÉ gi·∫£m kh·∫£ nƒÉng b·ªã block\ntry{const u=new URL(url);u.hostname=u.hostname.replace('www.youtube.com','www.youtube-nocookie.com').replace('youtube.com','www.youtube-nocookie.com');return u.toString();}catch(e){return url;}}// N·∫øu l√† watch URL, extract video ID\ntry{const urlObj=new URL(url);if(urlObj.hostname.includes('youtube.com')||urlObj.hostname.includes('www.youtube.com')){const videoId=urlObj.searchParams.get('v');if(videoId)return\"https://www.youtube-nocookie.com/embed/\".concat(videoId);}if(urlObj.hostname.includes('youtu.be')){const videoId=urlObj.pathname.slice(1).split('?')[0];if(videoId)return\"https://www.youtube-nocookie.com/embed/\".concat(videoId);}}catch(e){console.error('Error parsing YouTube URL:',e);return null;}return null;};const isSearchEmbed=url=>{if(!url)return false;try{const u=new URL(url);const params=u.searchParams;if(params.get('listType')==='search')return true;// if it's an embed without a video id and contains 'list=' it's likely a search/embed playlist\nif(u.pathname&&u.pathname.includes('/embed')&&params.get('list'))return true;return false;}catch(e){return false;}};const openMovie=async movie=>{console.debug('openMovie called for',movie&&movie.id,movie&&movie.title);// Create a unique id for this history entry so we can update it later\nconst historyId=\"\".concat(Date.now(),\"-\").concat(Math.floor(Math.random()*100000));// Push a placeholder entry into history immediately so UI shows right away\nconst placeholder=_objectSpread(_objectSpread({},movie),{},{video_url:movie.video_url||null,poster_url:movie.poster_url||null,loadingTrailer:!movie.video_url,historyId});setMovieHistory(prev=>[...prev,placeholder]);// Record a view interaction for personalization (best-effort)\ntry{const stored=localStorage.getItem('user');const user=stored?JSON.parse(stored):null;if(user&&user.userId){fetch(\"\".concat(API_BASE,\"/interactions\"),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.userId,movieId:movie.id,action:'view'})}).catch(()=>{});}}catch(e){}// Fetch user's last interaction for this movie to restore like/dislike state\ntry{const stored=localStorage.getItem('user');const user=stored?JSON.parse(stored):null;if(user&&user.userId){// Check local cache first\ntry{const cacheKey=\"likes_cache_\".concat(user.userId);const raw=localStorage.getItem(cacheKey);if(raw){const map=JSON.parse(raw);if(map&&map[movie.id]){const action=map[movie.id];if(action==='like'){setLikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movie.id]:true}));setDislikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movie.id]:false}));}else if(action==='dislike'){setDislikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movie.id]:true}));setLikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movie.id]:false}));}// skip remote fetch when cached\nreturn;}}}catch(e){// ignore cache failures\n}// remote fetch with limit=1 for speed\nfetch(\"\".concat(API_BASE,\"/interactions?user_id=\").concat(encodeURIComponent(user.userId),\"&movie_id=\").concat(movie.id,\"&limit=1\")).then(res=>res.ok?res.json():null).then(data=>{if(data&&data.results&&data.results.length>0){const last=data.results[0];if(last.action==='like'){setLikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movie.id]:true}));setDislikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movie.id]:false}));// update cache\ntry{const cacheKey=\"likes_cache_\".concat(user.userId);const raw=localStorage.getItem(cacheKey);const map=raw?JSON.parse(raw):{};map[movie.id]='like';localStorage.setItem(cacheKey,JSON.stringify(map));}catch(e){}}else if(last.action==='dislike'){setDislikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movie.id]:true}));setLikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movie.id]:false}));try{const cacheKey=\"likes_cache_\".concat(user.userId);const raw=localStorage.getItem(cacheKey);const map=raw?JSON.parse(raw):{};map[movie.id]='dislike';localStorage.setItem(cacheKey,JSON.stringify(map));}catch(e){}}}}).catch(()=>{});}}catch(e){}// Fetch and update trailer/poster asynchronously if we don't already have a video\nif(!movie.video_url){try{const resp=await fetch(\"\".concat(API_BASE,\"/movies/\").concat(movie.id,\"/trailer\"));console.debug('trailer endpoint response status',resp.status);if(resp.ok){const data=await resp.json();console.debug('trailer endpoint data',data);// Update the history entry by historyId\nsetMovieHistory(prev=>prev.map(entry=>{if(entry.historyId===historyId){return _objectSpread(_objectSpread({},entry),{},{video_url:(data===null||data===void 0?void 0:data.video_url)||entry.video_url,poster_url:(data===null||data===void 0?void 0:data.poster_url)||entry.poster_url,loadingTrailer:false});}return entry;}));}else{// still mark as not loading and provide fallback\nsetMovieHistory(prev=>prev.map(entry=>entry.historyId===historyId?_objectSpread(_objectSpread({},entry),{},{loadingTrailer:false}):entry));}}catch(err){console.error('Failed to fetch trailer endpoint:',err);setMovieHistory(prev=>prev.map(entry=>entry.historyId===historyId?_objectSpread(_objectSpread({},entry),{},{loadingTrailer:false}):entry));}// If after the fetch there's still no video_url, set a YouTube search URL fallback (but don't embed it)\nsetMovieHistory(prev=>prev.map(entry=>{if(entry.historyId!==historyId)return entry;if(entry.video_url)return entry;try{const title=entry.title||'';const year=entry.year?\" \".concat(entry.year):'';const query=encodeURIComponent(\"\".concat(title).concat(year,\" trailer\"));return _objectSpread(_objectSpread({},entry),{},{// store a search URL (we will open it in new tab rather than embedding)\nvideo_url:\"https://www.youtube.com/results?search_query=\".concat(query)});}catch(e){return entry;}}));}// Fetch similar movies in background (non-blocking)\nif(!similarMoviesCache[movie.id]){fetch(\"\".concat(API_BASE,\"/recommendations?rec_type=content&movie_id=\").concat(movie.id,\"&n=10\")).then(response=>response.ok?response.json():null).then(data=>{if(data&&data.results){setSimilarMoviesCache(prev=>_objectSpread(_objectSpread({},prev),{},{[movie.id]:data.results}));}}).catch(err=>console.error('Failed to fetch similar movies:',err));}// Fetch latest comments for this movie (background)\ntry{fetch(\"\".concat(API_BASE,\"/movies/\").concat(movie.id,\"/comments?limit=20\")).then(res=>res.ok?res.json():null).then(data=>{if(data&&data.comments){setComments(data.comments);setShowAllComments(false);}}).catch(()=>{});}catch(e){}};const handleLike=async()=>{if(!currentMovie)return;try{// Persist interaction to server with userId\nconst stored=localStorage.getItem('user');const user=stored?JSON.parse(stored):null;if(user&&user.userId){await fetch(\"\".concat(API_BASE,\"/interactions\"),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.userId,movieId:currentMovie.id,action:'like'})});}else{await fetch(\"\".concat(API_BASE,\"/movies/\").concat(currentMovie.id,\"/like\"),{method:'POST'});}const movieId=currentMovie.id;setLikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movieId]:!prev[movieId]}));// If clicking like, remove dislike\nif(!likes[movieId]){setDislikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movieId]:false}));}}catch(err){console.error('Failed to like movie:',err);}};const handleDislike=async()=>{if(!currentMovie)return;try{const stored=localStorage.getItem('user');const user=stored?JSON.parse(stored):null;if(user&&user.userId){await fetch(\"\".concat(API_BASE,\"/interactions\"),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.userId,movieId:currentMovie.id,action:'dislike'})});}else{await fetch(\"\".concat(API_BASE,\"/movies/\").concat(currentMovie.id,\"/dislike\"),{method:'POST'});}const movieId=currentMovie.id;setDislikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movieId]:!prev[movieId]}));// If clicking dislike, remove like\nif(!dislikes[movieId]){setLikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movieId]:false}));}}catch(err){console.error('Failed to dislike movie:',err);}};// Quick submit rating (1-5 sao) without opening modal\nconst handleRate=async star=>{if(!currentMovie)return;try{const stored=localStorage.getItem('user');const user=stored?JSON.parse(stored):null;const payload={rating:star,review_text:'',username:user&&user.userId?user.userId:'Anonymous'};const response=await fetch(\"\".concat(API_BASE,\"/movies/\").concat(currentMovie.id,\"/review\"),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(response.ok){setReviewRating(star);alert('C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°!');}else{alert('G·ª≠i ƒë√°nh gi√° th·∫•t b·∫°i');}}catch(err){console.error('Failed to submit rating:',err);alert('L·ªói khi g·ª≠i ƒë√°nh gi√°. Vui l√≤ng th·ª≠ l·∫°i!');}};const handleSubmitComment=async()=>{if(!currentMovie)return;try{const stored=localStorage.getItem('user');const user=stored?JSON.parse(stored):null;const payload={userId:user&&user.userId?user.userId:'Anonymous',comment:commentText||''};// If we have a registered display name locally, ensure server has the user metadata\nif(user&&user.userId&&(user.name||user.email)){try{await fetch(\"\".concat(API_BASE,\"/users\"),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.userId,metadata:JSON.stringify({name:user.name,email:user.email})})});}catch(e){// best-effort - ignore errors\n}}if(!payload.comment.trim()){alert('Vui l√≤ng nh·∫≠p b√¨nh lu·∫≠n');return;}const resp=await fetch(\"\".concat(API_BASE,\"/movies/\").concat(currentMovie.id,\"/comment\"),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(resp.ok){const data=await resp.json();// prepend local comment to list and include display_name for immediate UI\nconst displayName=user&&(user.name||user.displayName)||payload.userId;setComments(prev=>[{id:Date.now(),movieId:currentMovie.id,userId:payload.userId,display_name:displayName,comment:payload.comment,timestamp:new Date().toISOString()},...prev]);setCommentText('');}else{alert('G·ª≠i b√¨nh lu·∫≠n th·∫•t b·∫°i');}}catch(e){console.error('Failed to submit comment',e);alert('L·ªói khi g·ª≠i b√¨nh lu·∫≠n');}};const goBack=()=>{if(movieHistory.length>1){// Remove current movie from history\nconst newHistory=[...movieHistory];newHistory.pop();setMovieHistory(newHistory);}else if(movieHistory.length===1){// Return to recommendations list\nsetMovieHistory([]);}};// Movie card component\nconst MovieCard=_ref2=>{var _movie$overview;let{movie,isCompact}=_ref2;return/*#__PURE__*/_jsxs(\"div\",{className:isCompact?styles.movieCardCompact:styles.movieCard,onClick:()=>openMovie(movie),children:[/*#__PURE__*/_jsxs(\"div\",{className:styles.moviePosterContainer,children:[movie.poster_url?/*#__PURE__*/_jsx(\"img\",{src:movie.poster_url,alt:movie.title,className:styles.moviePoster,loading:\"lazy\"}):/*#__PURE__*/_jsx(\"div\",{className:styles.moviePosterPlaceholder,children:/*#__PURE__*/_jsx(\"p\",{children:\"Kh\\xF4ng c\\xF3 Poster\"})}),/*#__PURE__*/_jsx(\"div\",{className:styles.playOverlay,children:\"\\u25B6\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:styles.movieDetails,children:[/*#__PURE__*/_jsxs(\"h3\",{className:styles.movieTitle,children:[movie.title,\" \",movie.year>0&&\"(\".concat(movie.year,\")\")]}),/*#__PURE__*/_jsxs(\"p\",{className:styles.rating,children:[\"\\u2B50 \",movie.vote_average||'N/A',\"/10\"]}),!isCompact&&/*#__PURE__*/_jsxs(\"p\",{className:styles.overview,children:[(_movie$overview=movie.overview)===null||_movie$overview===void 0?void 0:_movie$overview.substring(0,100),\"...\"]})]})]});};const handleGetRecommendations=async()=>{setLoading(true);setError('');setRecommendations([]);try{// Fast-path: load from cache first to render immediately\nconst stored=localStorage.getItem('user');const user=stored?JSON.parse(stored):null;const cacheKey=\"cached_recs_\".concat(recType,\"_\").concat(user&&user.userId?user.userId:'public');try{const raw=localStorage.getItem(cacheKey);if(raw){const parsed=JSON.parse(raw);const movies=parsed.results||[];if(movies.length>0){setRecommendations(movies);setLoading(false);}}}catch(e){}const userParam=user&&user.userId?\"&user_id=\".concat(encodeURIComponent(user.userId)):'';const url=\"\".concat(API_BASE,\"/recommendations?rec_type=\").concat(encodeURIComponent(recType),\"&n=10\").concat(userParam);const response=await fetch(url);if(!response.ok){const errorText=await response.text();throw new Error(\"L\\u1ED7i l\\u1EA5y g\\u1EE3i \\xFD: \".concat(response.status,\" - \").concat(errorText.substring(0,200)));}const data=await response.json();const results=data.results||[];// update UI and cache\nsetRecommendations(results);try{localStorage.setItem(cacheKey,JSON.stringify({ts:Date.now(),results}));}catch(e){}if(results.length===0)setError('Kh√¥ng t√¨m th·∫•y g·ª£i √Ω n√†o.');}catch(err){setError(\"Th\\u1EA5t b\\u1EA1i khi k\\u1EBFt n\\u1ED1i: \".concat(err.message));}finally{setLoading(false);}};useEffect(()=>{handleGetRecommendations();},[]);return/*#__PURE__*/_jsx(\"div\",{className:styles.mainContent,children:!currentMovie?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"header\",{className:styles.header,children:/*#__PURE__*/_jsx(\"h1\",{className:styles.pageHeader,children:\"\\u2B50 \\u0110\\u1EC1 Xu\\u1EA5t Phim Cho B\\u1EA1n\"})}),error&&/*#__PURE__*/_jsx(\"div\",{className:styles.error,children:error}),loading&&/*#__PURE__*/_jsx(\"div\",{className:styles.loading,children:\"\\u0110ang t\\u1EA3i phim \\u0111\\u1EC1 xu\\u1EA5t...\"}),recommendations.length>0&&/*#__PURE__*/_jsxs(\"div\",{className:styles.recommendationsContainer,children:[/*#__PURE__*/_jsxs(\"h2\",{className:styles.rowTitle,children:[\"\\uD83C\\uDFAC \\u0110\\u1EC1 xu\\u1EA5t h\\xE0ng \\u0111\\u1EA7u (\",recommendations.length,\")\"]}),/*#__PURE__*/_jsx(\"div\",{className:styles.movieRow,children:recommendations.map((movie,idx)=>/*#__PURE__*/_jsx(MovieCard,{movie:movie},idx))})]})]}):/*#__PURE__*/_jsxs(\"div\",{className:styles.moviePlayerContainer,children:[/*#__PURE__*/_jsx(\"button\",{className:styles.backButton,onClick:goBack,children:\"\\u2190 Quay l\\u1EA1i\"}),/*#__PURE__*/_jsxs(\"div\",{className:styles.playerSection,children:[/*#__PURE__*/_jsx(\"div\",{className:styles.videoPlayer,children:(()=>{const embed=currentMovie.video_url?getYouTubeEmbedUrl(currentMovie.video_url)||currentMovie.video_url:null;const searchEmbed=embed?isSearchEmbed(embed):false;// If we have a proper embed and it's not a search-type embed, show iframe\nif(embed&&!searchEmbed&&embed.includes('/embed')){const sep=embed.includes('?')?'&':'?';return/*#__PURE__*/_jsx(\"iframe\",{width:\"100%\",height:\"100%\",title:currentMovie.title,frameBorder:\"0\",allow:\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\",allowFullScreen:true,referrerPolicy:\"strict-origin-when-cross-origin\",src:\"\".concat(embed).concat(sep,\"autoplay=1&mute=0&rel=0&modestbranding=1\")});}// Otherwise show poster with message + button to open YouTube search\nif(currentMovie.poster_url){return/*#__PURE__*/_jsxs(\"div\",{className:styles.noPoster,children:[/*#__PURE__*/_jsx(\"img\",{src:currentMovie.poster_url,alt:currentMovie.title,style:{width:'100%',height:'100%',objectFit:'contain'}}),/*#__PURE__*/_jsx(\"div\",{className:styles.noVideoOverlay,children:currentMovie.loadingTrailer?'ƒêang t·∫£i phim...':'Trailer kh√¥ng kh·∫£ d·ª•ng'}),/*#__PURE__*/_jsx(\"div\",{style:{position:'absolute',right:12,bottom:12},children:/*#__PURE__*/_jsx(\"button\",{className:styles.openYouTubeBtn,onClick:()=>window.open(currentMovie.video_url||\"https://www.youtube.com/results?search_query=\".concat(encodeURIComponent(currentMovie.title||'')),'_blank'),children:\"M\\u1EDF trailer tr\\xEAn YouTube\"})})]});}return/*#__PURE__*/_jsx(\"div\",{className:styles.noVideo,children:currentMovie.loadingTrailer?'ƒêang t·∫£i phim...':'Kh√¥ng c√≥ trailer'});})()}),/*#__PURE__*/_jsxs(\"div\",{className:styles.movieInfo,children:[/*#__PURE__*/_jsxs(\"h1\",{className:styles.movieInfoTitle,children:[currentMovie.title,\" \",currentMovie.year>0&&\"(\".concat(currentMovie.year,\")\")]}),/*#__PURE__*/_jsxs(\"div\",{className:styles.movieMeta,children:[/*#__PURE__*/_jsxs(\"span\",{className:styles.movieRating,children:[\"\\u2B50 \",currentMovie.vote_average||'N/A',\"/10\"]}),/*#__PURE__*/_jsxs(\"span\",{className:styles.movieVotes,children:[\"(\",currentMovie.vote_count||0,\" votes)\"]})]}),/*#__PURE__*/_jsx(\"p\",{className:styles.movieDescription,children:currentMovie.overview}),/*#__PURE__*/_jsxs(\"div\",{className:styles.interactionButtons,children:[/*#__PURE__*/_jsx(\"button\",{className:\"\".concat(styles.likeBtn,\" \").concat(likes[currentMovie.id]?styles.active:''),onClick:handleLike,title:\"Th\\xEDch phim n\\xE0y\",children:\"Th\\xEDch\"}),/*#__PURE__*/_jsx(\"button\",{className:\"\".concat(styles.dislikeBtn,\" \").concat(dislikes[currentMovie.id]?styles.active:''),onClick:handleDislike,title:\"Kh\\xF4ng th\\xEDch\",children:\"Kh\\xF4ng th\\xEDch\"}),/*#__PURE__*/_jsx(\"div\",{className:styles.ratingInline,children:[1,2,3,4,5].map(star=>/*#__PURE__*/_jsx(\"button\",{className:\"\".concat(styles.star,\" \").concat((hoverRating||reviewRating)>=star?styles.starActive:''),onClick:()=>handleRate(star),onMouseEnter:()=>setHoverRating(star),onMouseLeave:()=>setHoverRating(0),title:\"\\u0110\\xE1nh gi\\xE1 \".concat(star,\" sao\"),children:\"\\u2B50\"},star))})]}),/*#__PURE__*/_jsxs(\"div\",{className:styles.commentsSection,children:[/*#__PURE__*/_jsx(\"h3\",{children:\"B\\xECnh lu\\u1EADn\"}),/*#__PURE__*/_jsxs(\"div\",{className:styles.commentForm,children:[/*#__PURE__*/_jsx(\"textarea\",{value:commentText,onChange:e=>setCommentText(e.target.value),placeholder:\"Vi\\u1EBFt b\\xECnh lu\\u1EADn...\",rows:3}),/*#__PURE__*/_jsx(\"button\",{className:styles.submitBtn,onClick:handleSubmitComment,children:\"G\\u1EEDi\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:styles.commentList,children:[comments.length===0&&/*#__PURE__*/_jsx(\"div\",{children:\"Ch\\u01B0a c\\xF3 b\\xECnh lu\\u1EADn n\\xE0o.\"}),comments.length>0&&(showAllComments?comments:comments.slice(0,2)).map(c=>/*#__PURE__*/_jsxs(\"div\",{className:styles.commentItem,children:[/*#__PURE__*/_jsxs(\"div\",{className:styles.commentMeta,children:[/*#__PURE__*/_jsx(\"strong\",{children:c.display_name||c.userId}),\" \\u2022 \",/*#__PURE__*/_jsx(\"span\",{className:styles.commentTime,children:new Date(c.timestamp).toLocaleString()})]}),/*#__PURE__*/_jsx(\"div\",{className:styles.commentText,children:c.comment})]},c.id)),comments.length>2&&/*#__PURE__*/_jsx(\"div\",{className:styles.commentToggle,children:/*#__PURE__*/_jsx(\"button\",{className:styles.smallBtn,onClick:()=>setShowAllComments(prev=>!prev),children:showAllComments?\"R\\xFAt g\\u1ECDn\":\"Xem th\\xEAm \".concat(comments.length-2,\" b\\xECnh lu\\u1EADn\")})})]})]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:styles.similarMoviesSection,children:[/*#__PURE__*/_jsx(\"h2\",{className:styles.sectionTitle,children:\"G\\u1EE3i \\xFD cho b\\u1EA1n\"}),similarMovies.length>0?/*#__PURE__*/_jsx(\"div\",{className:styles.similarMoviesGrid,children:similarMovies.map((movie,idx)=>/*#__PURE__*/_jsx(MovieCard,{movie:movie,isCompact:true},idx))}):/*#__PURE__*/_jsx(\"div\",{className:styles.loadingMovies,children:\"\\u0110ang t\\u1EA3i...\"})]}),/*#__PURE__*/_jsx(\"div\",{style:{marginTop:12},children:/*#__PURE__*/_jsx(\"button\",{className:styles.openYouTubeBtn,onClick:()=>{const title=(currentMovie===null||currentMovie===void 0?void 0:currentMovie.title)||'';const year=currentMovie!==null&&currentMovie!==void 0&&currentMovie.year?\" \".concat(currentMovie.year):'';const query=encodeURIComponent(\"\".concat(title).concat(year,\" trailer\"));window.open(\"https://www.youtube.com/results?search_query=\".concat(query),'_blank');},children:\"M\\u1EDF trailer tr\\xEAn YouTube\"})})]})});}","map":{"version":3,"names":["React","useState","useEffect","styles","API_BASE","jsx","_jsx","jsxs","_jsxs","Fragment","_Fragment","RecommendationsPage","_ref","onBack","initialMovie","recType","recommendations","setRecommendations","loading","setLoading","error","setError","movieHistory","setMovieHistory","similarMoviesCache","setSimilarMoviesCache","likes","setLikes","dislikes","setDislikes","reviewRating","setReviewRating","comments","setComments","commentText","setCommentText","showAllComments","setShowAllComments","hoverRating","setHoverRating","currentMovie","length","similarMovies","id","last","openMovie","getYouTubeEmbedUrl","url","includes","u","URL","hostname","replace","toString","e","urlObj","videoId","searchParams","get","concat","pathname","slice","split","console","isSearchEmbed","params","movie","debug","title","historyId","Date","now","Math","floor","random","placeholder","_objectSpread","video_url","poster_url","loadingTrailer","prev","stored","localStorage","getItem","user","JSON","parse","userId","fetch","method","headers","body","stringify","movieId","action","catch","cacheKey","raw","map","encodeURIComponent","then","res","ok","json","data","results","setItem","resp","status","entry","err","year","query","response","handleLike","handleDislike","handleRate","star","payload","rating","review_text","username","alert","handleSubmitComment","comment","name","email","metadata","trim","displayName","display_name","timestamp","toISOString","goBack","newHistory","pop","MovieCard","_ref2","_movie$overview","isCompact","className","movieCardCompact","movieCard","onClick","children","moviePosterContainer","src","alt","moviePoster","moviePosterPlaceholder","playOverlay","movieDetails","movieTitle","vote_average","overview","substring","handleGetRecommendations","parsed","movies","userParam","errorText","text","Error","ts","message","mainContent","header","pageHeader","recommendationsContainer","rowTitle","movieRow","idx","moviePlayerContainer","backButton","playerSection","videoPlayer","embed","searchEmbed","sep","width","height","frameBorder","allow","allowFullScreen","referrerPolicy","noPoster","style","objectFit","noVideoOverlay","position","right","bottom","openYouTubeBtn","window","open","noVideo","movieInfo","movieInfoTitle","movieMeta","movieRating","movieVotes","vote_count","movieDescription","interactionButtons","likeBtn","active","dislikeBtn","ratingInline","starActive","onMouseEnter","onMouseLeave","commentsSection","commentForm","value","onChange","target","rows","submitBtn","commentList","c","commentItem","commentMeta","commentTime","toLocaleString","commentToggle","smallBtn","similarMoviesSection","sectionTitle","similarMoviesGrid","loadingMovies","marginTop"],"sources":["D:/cn/phim/frontend/src/pages/RecommendationsPage.js"],"sourcesContent":["import React, { useState, useEffect } from 'react';\r\nimport styles from './RecommendationsPage.module.css';\r\nimport { API_BASE } from '../config';\r\n\r\nexport default function RecommendationsPage({ onBack, initialMovie }) {\r\n    const [recType] = useState('hybrid');\r\n    const [recommendations, setRecommendations] = useState([]);\r\n    const [loading, setLoading] = useState(false);\r\n    const [error, setError] = useState('');\r\n    const [movieHistory, setMovieHistory] = useState([]); // Stack of viewed movies\r\n    const [similarMoviesCache, setSimilarMoviesCache] = useState({}); // Cache similar movies by movie ID\r\n    const [likes, setLikes] = useState({}); // Track liked movies\r\n    const [dislikes, setDislikes] = useState({}); // Track disliked movies\r\n    const [reviewRating, setReviewRating] = useState(0); // Review rating (1-5)\r\n    const [comments, setComments] = useState([]);\r\n    const [commentText, setCommentText] = useState('');\r\n    const [showAllComments, setShowAllComments] = useState(false);\r\n    const [hoverRating, setHoverRating] = useState(0); // Hover rating for preview\r\n    \r\n    const currentMovie = movieHistory.length > 0 ? movieHistory[movieHistory.length - 1] : null;\r\n    const similarMovies = currentMovie ? (similarMoviesCache[currentMovie.id] || []) : [];\r\n\r\n    // Load initial movie if provided (from HomePage click)\r\n    useEffect(() => {\r\n        if (initialMovie) {\r\n            // If history is empty or last movie differs, open the initial movie\r\n            const last = movieHistory.length > 0 ? movieHistory[movieHistory.length - 1] : null;\r\n            if (!last || last.id !== initialMovie.id) {\r\n                openMovie(initialMovie);\r\n            }\r\n        }\r\n    }, [initialMovie]);\r\n\r\n    const getYouTubeEmbedUrl = (url) => {\r\n        if (!url) return null;\r\n        \r\n        // N·∫øu l√† embed URL, tr·∫£ v·ªÅ tr·ª±c ti·∫øp\r\n        if (url.includes('/embed')) {\r\n            // N·∫øu backend tr·∫£ v·ªÅ URL embed, chuy·ªÉn hostname sang youtube-nocookie ƒë·ªÉ gi·∫£m kh·∫£ nƒÉng b·ªã block\r\n            try {\r\n                const u = new URL(url);\r\n                u.hostname = u.hostname.replace('www.youtube.com', 'www.youtube-nocookie.com').replace('youtube.com', 'www.youtube-nocookie.com');\r\n                return u.toString();\r\n            } catch (e) {\r\n                return url;\r\n            }\r\n        }\r\n        \r\n        // N·∫øu l√† watch URL, extract video ID\r\n        try {\r\n            const urlObj = new URL(url);\r\n            if (urlObj.hostname.includes('youtube.com') || urlObj.hostname.includes('www.youtube.com')) {\r\n                const videoId = urlObj.searchParams.get('v');\r\n                if (videoId) return `https://www.youtube-nocookie.com/embed/${videoId}`;\r\n            }\r\n            if (urlObj.hostname.includes('youtu.be')) {\r\n                const videoId = urlObj.pathname.slice(1).split('?')[0];\r\n                if (videoId) return `https://www.youtube-nocookie.com/embed/${videoId}`;\r\n            }\r\n        } catch (e) {\r\n            console.error('Error parsing YouTube URL:', e);\r\n            return null;\r\n        }\r\n        return null;\r\n    };\r\n\r\n    const isSearchEmbed = (url) => {\r\n        if (!url) return false;\r\n        try {\r\n            const u = new URL(url);\r\n            const params = u.searchParams;\r\n            if (params.get('listType') === 'search') return true;\r\n            // if it's an embed without a video id and contains 'list=' it's likely a search/embed playlist\r\n            if (u.pathname && u.pathname.includes('/embed') && params.get('list')) return true;\r\n            return false;\r\n        } catch (e) {\r\n            return false;\r\n        }\r\n    };\r\n\r\n    const openMovie = async (movie) => {\r\n        console.debug('openMovie called for', movie && movie.id, movie && movie.title);\r\n\r\n        // Create a unique id for this history entry so we can update it later\r\n        const historyId = `${Date.now()}-${Math.floor(Math.random() * 100000)}`;\r\n\r\n        // Push a placeholder entry into history immediately so UI shows right away\r\n        const placeholder = {\r\n            ...movie,\r\n            video_url: movie.video_url || null,\r\n            poster_url: movie.poster_url || null,\r\n            loadingTrailer: !movie.video_url,\r\n            historyId,\r\n        };\r\n\r\n        setMovieHistory(prev => ([...prev, placeholder]));\r\n\r\n        // Record a view interaction for personalization (best-effort)\r\n        try {\r\n            const stored = localStorage.getItem('user');\r\n            const user = stored ? JSON.parse(stored) : null;\r\n            if (user && user.userId) {\r\n                fetch(`${API_BASE}/interactions`, {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({ userId: user.userId, movieId: movie.id, action: 'view' })\r\n                }).catch(()=>{});\r\n            }\r\n        } catch (e) {}\r\n\r\n        // Fetch user's last interaction for this movie to restore like/dislike state\r\n        try {\r\n            const stored = localStorage.getItem('user');\r\n            const user = stored ? JSON.parse(stored) : null;\r\n            if (user && user.userId) {\r\n                // Check local cache first\r\n                try {\r\n                    const cacheKey = `likes_cache_${user.userId}`;\r\n                    const raw = localStorage.getItem(cacheKey);\r\n                    if (raw) {\r\n                        const map = JSON.parse(raw);\r\n                        if (map && map[movie.id]) {\r\n                            const action = map[movie.id];\r\n                            if (action === 'like') {\r\n                                setLikes(prev => ({ ...prev, [movie.id]: true }));\r\n                                setDislikes(prev => ({ ...prev, [movie.id]: false }));\r\n                            } else if (action === 'dislike') {\r\n                                setDislikes(prev => ({ ...prev, [movie.id]: true }));\r\n                                setLikes(prev => ({ ...prev, [movie.id]: false }));\r\n                            }\r\n                            // skip remote fetch when cached\r\n                            return;\r\n                        }\r\n                    }\r\n                } catch (e) {\r\n                    // ignore cache failures\r\n                }\r\n\r\n                // remote fetch with limit=1 for speed\r\n                fetch(`${API_BASE}/interactions?user_id=${encodeURIComponent(user.userId)}&movie_id=${movie.id}&limit=1`)\r\n                    .then(res => res.ok ? res.json() : null)\r\n                    .then(data => {\r\n                        if (data && data.results && data.results.length > 0) {\r\n                            const last = data.results[0];\r\n                            if (last.action === 'like') {\r\n                                setLikes(prev => ({ ...prev, [movie.id]: true }));\r\n                                setDislikes(prev => ({ ...prev, [movie.id]: false }));\r\n                                // update cache\r\n                                try {\r\n                                    const cacheKey = `likes_cache_${user.userId}`;\r\n                                    const raw = localStorage.getItem(cacheKey);\r\n                                    const map = raw ? JSON.parse(raw) : {};\r\n                                    map[movie.id] = 'like';\r\n                                    localStorage.setItem(cacheKey, JSON.stringify(map));\r\n                                } catch (e) {}\r\n                            } else if (last.action === 'dislike') {\r\n                                setDislikes(prev => ({ ...prev, [movie.id]: true }));\r\n                                setLikes(prev => ({ ...prev, [movie.id]: false }));\r\n                                try {\r\n                                    const cacheKey = `likes_cache_${user.userId}`;\r\n                                    const raw = localStorage.getItem(cacheKey);\r\n                                    const map = raw ? JSON.parse(raw) : {};\r\n                                    map[movie.id] = 'dislike';\r\n                                    localStorage.setItem(cacheKey, JSON.stringify(map));\r\n                                } catch (e) {}\r\n                            }\r\n                        }\r\n                    }).catch(()=>{});\r\n            }\r\n        } catch (e) {}\r\n\r\n        // Fetch and update trailer/poster asynchronously if we don't already have a video\r\n        if (!movie.video_url) {\r\n            try {\r\n                const resp = await fetch(`${API_BASE}/movies/${movie.id}/trailer`);\r\n                console.debug('trailer endpoint response status', resp.status);\r\n                if (resp.ok) {\r\n                    const data = await resp.json();\r\n                    console.debug('trailer endpoint data', data);\r\n                    // Update the history entry by historyId\r\n                    setMovieHistory(prev => prev.map(entry => {\r\n                        if (entry.historyId === historyId) {\r\n                            return {\r\n                                ...entry,\r\n                                video_url: data?.video_url || entry.video_url,\r\n                                poster_url: data?.poster_url || entry.poster_url,\r\n                                loadingTrailer: false,\r\n                            };\r\n                        }\r\n                        return entry;\r\n                    }));\r\n                } else {\r\n                    // still mark as not loading and provide fallback\r\n                    setMovieHistory(prev => prev.map(entry => entry.historyId === historyId ? ({...entry, loadingTrailer: false}) : entry));\r\n                }\r\n            } catch (err) {\r\n                console.error('Failed to fetch trailer endpoint:', err);\r\n                setMovieHistory(prev => prev.map(entry => entry.historyId === historyId ? ({...entry, loadingTrailer: false}) : entry));\r\n            }\r\n\r\n            // If after the fetch there's still no video_url, set a YouTube search URL fallback (but don't embed it)\r\n            setMovieHistory(prev => prev.map(entry => {\r\n                if (entry.historyId !== historyId) return entry;\r\n                if (entry.video_url) return entry;\r\n                try {\r\n                    const title = entry.title || '';\r\n                    const year = entry.year ? ` ${entry.year}` : '';\r\n                    const query = encodeURIComponent(`${title}${year} trailer`);\r\n                    return {\r\n                        ...entry,\r\n                        // store a search URL (we will open it in new tab rather than embedding)\r\n                        video_url: `https://www.youtube.com/results?search_query=${query}`\r\n                    };\r\n                } catch (e) {\r\n                    return entry;\r\n                }\r\n            }));\r\n        }\r\n\r\n        // Fetch similar movies in background (non-blocking)\r\n        if (!similarMoviesCache[movie.id]) {\r\n            fetch(`${API_BASE}/recommendations?rec_type=content&movie_id=${movie.id}&n=10`)\r\n                .then(response => response.ok ? response.json() : null)\r\n                .then(data => {\r\n                    if (data && data.results) {\r\n                        setSimilarMoviesCache(prev => ({\r\n                            ...prev,\r\n                            [movie.id]: data.results\r\n                        }));\r\n                    }\r\n                })\r\n                .catch(err => console.error('Failed to fetch similar movies:', err));\r\n        }\r\n\r\n        // Fetch latest comments for this movie (background)\r\n        try {\r\n            fetch(`${API_BASE}/movies/${movie.id}/comments?limit=20`)\r\n                .then(res => res.ok ? res.json() : null)\r\n                .then(data => {\r\n                    if (data && data.comments) {\r\n                        setComments(data.comments);\r\n                        setShowAllComments(false);\r\n                    }\r\n                }).catch(()=>{});\r\n        } catch (e) {}\r\n    };\r\n\r\n    const handleLike = async () => {\r\n        if (!currentMovie) return;\r\n        try {\r\n            // Persist interaction to server with userId\r\n            const stored = localStorage.getItem('user');\r\n            const user = stored ? JSON.parse(stored) : null;\r\n            if (user && user.userId) {\r\n                await fetch(`${API_BASE}/interactions`, {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({ userId: user.userId, movieId: currentMovie.id, action: 'like' })\r\n                });\r\n            } else {\r\n                await fetch(`${API_BASE}/movies/${currentMovie.id}/like`, { method: 'POST' });\r\n            }\r\n            const movieId = currentMovie.id;\r\n            setLikes(prev => ({ ...prev, [movieId]: !prev[movieId] }));\r\n            // If clicking like, remove dislike\r\n            if (!likes[movieId]) {\r\n                setDislikes(prev => ({ ...prev, [movieId]: false }));\r\n            }\r\n        } catch (err) {\r\n            console.error('Failed to like movie:', err);\r\n        }\r\n    };\r\n\r\n    const handleDislike = async () => {\r\n        if (!currentMovie) return;\r\n        try {\r\n            const stored = localStorage.getItem('user');\r\n            const user = stored ? JSON.parse(stored) : null;\r\n            if (user && user.userId) {\r\n                await fetch(`${API_BASE}/interactions`, {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({ userId: user.userId, movieId: currentMovie.id, action: 'dislike' })\r\n                });\r\n            } else {\r\n                await fetch(`${API_BASE}/movies/${currentMovie.id}/dislike`, { method: 'POST' });\r\n            }\r\n            const movieId = currentMovie.id;\r\n            setDislikes(prev => ({ ...prev, [movieId]: !prev[movieId] }));\r\n            // If clicking dislike, remove like\r\n            if (!dislikes[movieId]) {\r\n                setLikes(prev => ({ ...prev, [movieId]: false }));\r\n            }\r\n        } catch (err) {\r\n            console.error('Failed to dislike movie:', err);\r\n        }\r\n    };\r\n\r\n    // Quick submit rating (1-5 sao) without opening modal\r\n    const handleRate = async (star) => {\r\n        if (!currentMovie) return;\r\n        try {\r\n            const stored = localStorage.getItem('user');\r\n            const user = stored ? JSON.parse(stored) : null;\r\n            const payload = {\r\n                rating: star,\r\n                review_text: '',\r\n                username: user && user.userId ? user.userId : 'Anonymous'\r\n            };\r\n            const response = await fetch(`${API_BASE}/movies/${currentMovie.id}/review`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify(payload)\r\n            });\r\n            if (response.ok) {\r\n                setReviewRating(star);\r\n                alert('C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°!');\r\n            } else {\r\n                alert('G·ª≠i ƒë√°nh gi√° th·∫•t b·∫°i');\r\n            }\r\n        } catch (err) {\r\n            console.error('Failed to submit rating:', err);\r\n            alert('L·ªói khi g·ª≠i ƒë√°nh gi√°. Vui l√≤ng th·ª≠ l·∫°i!');\r\n        }\r\n    };\r\n\r\n    const handleSubmitComment = async () => {\r\n        if (!currentMovie) return;\r\n        try {\r\n            const stored = localStorage.getItem('user');\r\n            const user = stored ? JSON.parse(stored) : null;\r\n            const payload = {\r\n                userId: user && user.userId ? user.userId : 'Anonymous',\r\n                comment: commentText || ''\r\n            };\r\n            // If we have a registered display name locally, ensure server has the user metadata\r\n            if (user && user.userId && (user.name || user.email)) {\r\n                try {\r\n                    await fetch(`${API_BASE}/users`, {\r\n                        method: 'POST',\r\n                        headers: { 'Content-Type': 'application/json' },\r\n                        body: JSON.stringify({ userId: user.userId, metadata: JSON.stringify({ name: user.name, email: user.email }) })\r\n                    });\r\n                } catch (e) {\r\n                    // best-effort - ignore errors\r\n                }\r\n            }\r\n            if (!payload.comment.trim()) {\r\n                alert('Vui l√≤ng nh·∫≠p b√¨nh lu·∫≠n');\r\n                return;\r\n            }\r\n            const resp = await fetch(`${API_BASE}/movies/${currentMovie.id}/comment`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify(payload)\r\n            });\r\n            if (resp.ok) {\r\n                const data = await resp.json();\r\n                // prepend local comment to list and include display_name for immediate UI\r\n                const displayName = (user && (user.name || user.displayName)) || payload.userId;\r\n                setComments(prev => ([{ id: Date.now(), movieId: currentMovie.id, userId: payload.userId, display_name: displayName, comment: payload.comment, timestamp: new Date().toISOString() }, ...prev]));\r\n                setCommentText('');\r\n            } else {\r\n                alert('G·ª≠i b√¨nh lu·∫≠n th·∫•t b·∫°i');\r\n            }\r\n        } catch (e) {\r\n            console.error('Failed to submit comment', e);\r\n            alert('L·ªói khi g·ª≠i b√¨nh lu·∫≠n');\r\n        }\r\n    };\r\n\r\n    const goBack = () => {\r\n        if (movieHistory.length > 1) {\r\n            // Remove current movie from history\r\n            const newHistory = [...movieHistory];\r\n            newHistory.pop();\r\n            setMovieHistory(newHistory);\r\n        } else if (movieHistory.length === 1) {\r\n            // Return to recommendations list\r\n            setMovieHistory([]);\r\n        }\r\n    };\r\n\r\n    // Movie card component\r\n    const MovieCard = ({ movie, isCompact }) => {\r\n        return (\r\n            <div className={isCompact ? styles.movieCardCompact : styles.movieCard} onClick={() => openMovie(movie)}>\r\n                <div className={styles.moviePosterContainer}>\r\n                    {movie.poster_url ? (\r\n                        <img src={movie.poster_url} alt={movie.title} className={styles.moviePoster} loading=\"lazy\" />\r\n                    ) : (\r\n                        <div className={styles.moviePosterPlaceholder}><p>Kh√¥ng c√≥ Poster</p></div>\r\n                    )}\r\n                    <div className={styles.playOverlay}>‚ñ∂</div>\r\n                </div>\r\n                <div className={styles.movieDetails}>\r\n                    <h3 className={styles.movieTitle}>{movie.title} {movie.year > 0 && `(${movie.year})`}</h3>\r\n                    <p className={styles.rating}>‚≠ê {movie.vote_average || 'N/A'}/10</p>\r\n                    {!isCompact && <p className={styles.overview}>{movie.overview?.substring(0, 100)}...</p>}\r\n                </div>\r\n            </div>\r\n        );\r\n    };\r\n\r\n    const handleGetRecommendations = async () => {\r\n        setLoading(true);\r\n        setError('');\r\n        setRecommendations([]);\r\n\r\n        try {\r\n            // Fast-path: load from cache first to render immediately\r\n            const stored = localStorage.getItem('user');\r\n            const user = stored ? JSON.parse(stored) : null;\r\n            const cacheKey = `cached_recs_${recType}_${user && user.userId ? user.userId : 'public'}`;\r\n            try {\r\n                const raw = localStorage.getItem(cacheKey);\r\n                if (raw) {\r\n                    const parsed = JSON.parse(raw);\r\n                    const movies = parsed.results || [];\r\n                    if (movies.length > 0) {\r\n                        setRecommendations(movies);\r\n                        setLoading(false);\r\n                    }\r\n                }\r\n            } catch (e) {}\r\n\r\n            const userParam = user && user.userId ? `&user_id=${encodeURIComponent(user.userId)}` : '';\r\n            const url = `${API_BASE}/recommendations?rec_type=${encodeURIComponent(recType)}&n=10${userParam}`;\r\n            const response = await fetch(url);\r\n            if (!response.ok) {\r\n                const errorText = await response.text();\r\n                throw new Error(`L·ªói l·∫•y g·ª£i √Ω: ${response.status} - ${errorText.substring(0, 200)}`);\r\n            }\r\n            const data = await response.json();\r\n            const results = data.results || [];\r\n            // update UI and cache\r\n            setRecommendations(results);\r\n            try {\r\n                localStorage.setItem(cacheKey, JSON.stringify({ ts: Date.now(), results }));\r\n            } catch (e) {}\r\n            if (results.length === 0) setError('Kh√¥ng t√¨m th·∫•y g·ª£i √Ω n√†o.');\r\n        } catch (err) {\r\n            setError(`Th·∫•t b·∫°i khi k·∫øt n·ªëi: ${err.message}`);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    useEffect(() => { handleGetRecommendations(); }, []);\r\n\r\n    return (\r\n        <div className={styles.mainContent}>\r\n            {!currentMovie ? (\r\n                <>\r\n                    <header className={styles.header}>\r\n                        <h1 className={styles.pageHeader}>‚≠ê ƒê·ªÅ Xu·∫•t Phim Cho B·∫°n</h1>\r\n                    </header>\r\n\r\n                    {error && <div className={styles.error}>{error}</div>}\r\n                    {loading && <div className={styles.loading}>ƒêang t·∫£i phim ƒë·ªÅ xu·∫•t...</div>}\r\n\r\n                    {recommendations.length > 0 && (\r\n                        <div className={styles.recommendationsContainer}>\r\n                            <h2 className={styles.rowTitle}>üé¨ ƒê·ªÅ xu·∫•t h√†ng ƒë·∫ßu ({recommendations.length})</h2>\r\n                            <div className={styles.movieRow}>\r\n                                {recommendations.map((movie, idx) => (<MovieCard key={idx} movie={movie} />))}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </>\r\n            ) : (\r\n                <div className={styles.moviePlayerContainer}>\r\n                    <button className={styles.backButton} onClick={goBack}>\r\n                        ‚Üê Quay l·∫°i\r\n                    </button>\r\n                    \r\n                    <div className={styles.playerSection}>\r\n                        <div className={styles.videoPlayer}>\r\n                            {(() => {\r\n                                const embed = currentMovie.video_url ? (getYouTubeEmbedUrl(currentMovie.video_url) || currentMovie.video_url) : null;\r\n                                const searchEmbed = embed ? isSearchEmbed(embed) : false;\r\n                                // If we have a proper embed and it's not a search-type embed, show iframe\r\n                                if (embed && !searchEmbed && embed.includes('/embed')) {\r\n                                    const sep = embed.includes('?') ? '&' : '?';\r\n                                    return (\r\n                                        <iframe\r\n                                            width=\"100%\"\r\n                                            height=\"100%\"\r\n                                            title={currentMovie.title}\r\n                                            frameBorder=\"0\"\r\n                                            allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\"\r\n                                            allowFullScreen\r\n                                            referrerPolicy=\"strict-origin-when-cross-origin\"\r\n                                            src={`${embed}${sep}autoplay=1&mute=0&rel=0&modestbranding=1`}\r\n                                        />\r\n                                    );\r\n                                }\r\n\r\n                                // Otherwise show poster with message + button to open YouTube search\r\n                                if (currentMovie.poster_url) {\r\n                                    return (\r\n                                        <div className={styles.noPoster}>\r\n                                            <img src={currentMovie.poster_url} alt={currentMovie.title} style={{width: '100%', height: '100%', objectFit: 'contain'}} />\r\n                                            <div className={styles.noVideoOverlay}>\r\n                                                {currentMovie.loadingTrailer ? 'ƒêang t·∫£i phim...' : 'Trailer kh√¥ng kh·∫£ d·ª•ng'}\r\n                                            </div>\r\n                                            <div style={{position: 'absolute', right: 12, bottom: 12}}>\r\n                                                <button className={styles.openYouTubeBtn} onClick={() => window.open(currentMovie.video_url || `https://www.youtube.com/results?search_query=${encodeURIComponent(currentMovie.title || '')}`, '_blank')}>\r\n                                                    M·ªü trailer tr√™n YouTube\r\n                                                </button>\r\n                                            </div>\r\n                                        </div>\r\n                                    );\r\n                                }\r\n\r\n                                return (\r\n                                    <div className={styles.noVideo}>\r\n                                        {currentMovie.loadingTrailer ? 'ƒêang t·∫£i phim...' : 'Kh√¥ng c√≥ trailer'}\r\n                                    </div>\r\n                                );\r\n                            })()}\r\n                        </div>\r\n                        \r\n                        <div className={styles.movieInfo}>\r\n                            <h1 className={styles.movieInfoTitle}>{currentMovie.title} {currentMovie.year > 0 && `(${currentMovie.year})`}</h1>\r\n                            <div className={styles.movieMeta}>\r\n                                <span className={styles.movieRating}>‚≠ê {currentMovie.vote_average || 'N/A'}/10</span>\r\n                                <span className={styles.movieVotes}>({currentMovie.vote_count || 0} votes)</span>\r\n                            </div>\r\n                            <p className={styles.movieDescription}>{currentMovie.overview}</p>\r\n\r\n                            {/* Like/Dislike/Review Buttons */}\r\n                            <div className={styles.interactionButtons}>\r\n                                <button \r\n                                    className={`${styles.likeBtn} ${likes[currentMovie.id] ? styles.active : ''}`}\r\n                                    onClick={handleLike}\r\n                                    title=\"Th√≠ch phim n√†y\"\r\n                                >\r\n                                    Th√≠ch\r\n                                </button>\r\n                                <button \r\n                                    className={`${styles.dislikeBtn} ${dislikes[currentMovie.id] ? styles.active : ''}`}\r\n                                    onClick={handleDislike}\r\n                                    title=\"Kh√¥ng th√≠ch\"\r\n                                >\r\n                                    Kh√¥ng th√≠ch\r\n                                </button>\r\n                                <div className={styles.ratingInline}>\r\n                                    {[1,2,3,4,5].map(star => (\r\n                                        <button\r\n                                            key={star}\r\n                                            className={`${styles.star} ${(hoverRating || reviewRating) >= star ? styles.starActive : ''}`}\r\n                                            onClick={() => handleRate(star)}\r\n                                            onMouseEnter={() => setHoverRating(star)}\r\n                                            onMouseLeave={() => setHoverRating(0)}\r\n                                            title={`ƒê√°nh gi√° ${star} sao`}\r\n                                        >\r\n                                            ‚≠ê\r\n                                        </button>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n                            {/* Comments section */}\r\n                            <div className={styles.commentsSection}>\r\n                                <h3>B√¨nh lu·∫≠n</h3>\r\n                                <div className={styles.commentForm}>\r\n                                    <textarea value={commentText} onChange={(e) => setCommentText(e.target.value)} placeholder=\"Vi·∫øt b√¨nh lu·∫≠n...\" rows={3} />\r\n                                    <button className={styles.submitBtn} onClick={handleSubmitComment}>G·ª≠i</button>\r\n                                </div>\r\n                                <div className={styles.commentList}>\r\n                                    {comments.length === 0 && <div>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</div>}\r\n                                    {comments.length > 0 && (\r\n                                        (showAllComments ? comments : comments.slice(0, 2)).map(c => (\r\n                                            <div key={c.id} className={styles.commentItem}>\r\n                                                <div className={styles.commentMeta}><strong>{c.display_name || c.userId}</strong> ‚Ä¢ <span className={styles.commentTime}>{new Date(c.timestamp).toLocaleString()}</span></div>\r\n                                                <div className={styles.commentText}>{c.comment}</div>\r\n                                            </div>\r\n                                        ))\r\n                                    )}\r\n\r\n                                    {comments.length > 2 && (\r\n                                        <div className={styles.commentToggle}>\r\n                                            <button className={styles.smallBtn} onClick={() => setShowAllComments(prev => !prev)}>\r\n                                                {showAllComments ? `R√∫t g·ªçn` : `Xem th√™m ${comments.length - 2} b√¨nh lu·∫≠n`}\r\n                                            </button>\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Review modal removed: replaced by quick star rating */}\r\n\r\n                    <div className={styles.similarMoviesSection}>\r\n                        <h2 className={styles.sectionTitle}>G·ª£i √Ω cho b·∫°n</h2>\r\n                        {similarMovies.length > 0 ? (\r\n                            <div className={styles.similarMoviesGrid}>\r\n                                {similarMovies.map((movie, idx) => (\r\n                                    <MovieCard key={idx} movie={movie} isCompact={true} />\r\n                                ))}\r\n                            </div>\r\n                        ) : (\r\n                            <div className={styles.loadingMovies}>ƒêang t·∫£i...</div>\r\n                        )}\r\n                    </div>\r\n                    <div style={{marginTop: 12}}>\r\n                        <button className={styles.openYouTubeBtn} onClick={() => {\r\n                            const title = currentMovie?.title || '';\r\n                            const year = currentMovie?.year ? ` ${currentMovie.year}` : '';\r\n                            const query = encodeURIComponent(`${title}${year} trailer`);\r\n                            window.open(`https://www.youtube.com/results?search_query=${query}`, '_blank');\r\n                        }}>\r\n                            M·ªü trailer tr√™n YouTube\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}