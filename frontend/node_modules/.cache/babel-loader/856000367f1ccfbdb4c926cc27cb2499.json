{"ast":null,"code":"import _objectSpread from\"D:/cn/phim/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect}from'react';import styles from'./RecommendationsPage.module.css';import{API_BASE}from'../config';import{MovieCardSkeleton}from'../components/MovieSkeleton';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";export default function RecommendationsPage(_ref){let{onBack,initialMovie}=_ref;const[recType]=useState('hybrid');const[recommendations,setRecommendations]=useState([]);const[loading,setLoading]=useState(true);const[error,setError]=useState('');const[movieHistory,setMovieHistory]=useState([]);// Stack of viewed movies\nconst[similarMoviesCache,setSimilarMoviesCache]=useState({});// Cache similar movies by movie ID\nconst[likes,setLikes]=useState({});// Track liked movies\nconst[dislikes,setDislikes]=useState({});// Track disliked movies\nconst[watchlist,setWatchlist]=useState({});// Track watchlist movies\nconst[reviewRating,setReviewRating]=useState(0);// Review rating (1-5)\nconst[comments,setComments]=useState([]);const[commentText,setCommentText]=useState('');const[showAllComments,setShowAllComments]=useState(false);const[hoverRating,setHoverRating]=useState(0);// Hover rating for preview\nconst[videoProgress,setVideoProgress]=useState({});// Track video progress {movieId: {timestamp, duration}}\nconst[player,setPlayer]=useState(null);// YouTube player instance\nconst playerRef=React.useRef(null);const currentMovie=movieHistory.length>0?movieHistory[movieHistory.length-1]:null;const similarMovies=currentMovie?similarMoviesCache[currentMovie.id]||[]:[];// Load saved video progress from localStorage\nuseEffect(()=>{try{const saved=localStorage.getItem('video_progress');if(saved){setVideoProgress(JSON.parse(saved));}}catch(e){console.warn('Failed to load video progress:',e);}},[]);// Load watchlist from localStorage on mount\nuseEffect(()=>{try{const stored=localStorage.getItem('user');const user=stored?JSON.parse(stored):null;if(user!==null&&user!==void 0&&user.userId){const cacheKey=\"watchlist_\".concat(user.userId);const cached=localStorage.getItem(cacheKey);if(cached){const watchlistData=JSON.parse(cached);const watchlistMap={};watchlistData.forEach(movie=>{watchlistMap[movie.id]=true;});setWatchlist(watchlistMap);}// Load likes/dislikes from cache on mount\nconst likesCacheKey=\"likes_cache_\".concat(user.userId);const likesCache=localStorage.getItem(likesCacheKey);if(likesCache){const likesMap=JSON.parse(likesCache);const newLikes={};const newDislikes={};Object.keys(likesMap).forEach(movieId=>{const action=likesMap[movieId];if(action==='like'){newLikes[movieId]=true;newDislikes[movieId]=false;}else if(action==='dislike'){newDislikes[movieId]=true;newLikes[movieId]=false;}});setLikes(newLikes);setDislikes(newDislikes);}}}catch(e){console.warn('Failed to load user state:',e);}},[]);// Load initial movie if provided (from HomePage click)\nuseEffect(()=>{if(initialMovie){// If history is empty or last movie differs, open the initial movie\nconst last=movieHistory.length>0?movieHistory[movieHistory.length-1]:null;if(!last||last.id!==initialMovie.id){openMovie(initialMovie);}}},[initialMovie]);const getYouTubeEmbedUrl=url=>{if(!url)return null;// Nếu là embed URL, trả về trực tiếp\nif(url.includes('/embed')){// Nếu backend trả về URL embed, chuyển hostname sang youtube-nocookie để giảm khả năng bị block\ntry{const u=new URL(url);u.hostname=u.hostname.replace('www.youtube.com','www.youtube-nocookie.com').replace('youtube.com','www.youtube-nocookie.com');return u.toString();}catch(e){return url;}}// Nếu là watch URL, extract video ID\ntry{const urlObj=new URL(url);if(urlObj.hostname.includes('youtube.com')||urlObj.hostname.includes('www.youtube.com')){const videoId=urlObj.searchParams.get('v');if(videoId)return\"https://www.youtube-nocookie.com/embed/\".concat(videoId);}if(urlObj.hostname.includes('youtu.be')){const videoId=urlObj.pathname.slice(1).split('?')[0];if(videoId)return\"https://www.youtube-nocookie.com/embed/\".concat(videoId);}}catch(e){console.error('Error parsing YouTube URL:',e);return null;}return null;};const isSearchEmbed=url=>{if(!url)return false;try{const u=new URL(url);const params=u.searchParams;if(params.get('listType')==='search')return true;// if it's an embed without a video id and contains 'list=' it's likely a search/embed playlist\nif(u.pathname&&u.pathname.includes('/embed')&&params.get('list'))return true;return false;}catch(e){return false;}};// Save video progress to localStorage and backend\nconst saveVideoProgress=async(movieId,timestamp,duration)=>{if(!movieId||timestamp===null||timestamp===undefined)return;// Save to state and localStorage\nconst newProgress=_objectSpread(_objectSpread({},videoProgress),{},{[movieId]:{timestamp:Math.floor(timestamp),duration:Math.floor(duration||0),savedAt:Date.now()}});setVideoProgress(newProgress);try{localStorage.setItem('video_progress',JSON.stringify(newProgress));}catch(e){console.warn('Failed to save progress to localStorage:',e);}// Save to backend watch history\ntry{const stored=localStorage.getItem('user');const user=stored?JSON.parse(stored):null;const userId=(user===null||user===void 0?void 0:user.userId)||'Anonymous';await fetch(\"\".concat(API_BASE,\"/watch-history\"),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:userId,movie_id:movieId,timestamp:Math.floor(timestamp),duration:Math.floor(duration||0)})});}catch(e){console.warn('Failed to save progress to backend:',e);}};const openMovie=async movie=>{console.debug('openMovie called for',movie&&movie.id,movie&&movie.title);// Create a unique id for this history entry so we can update it later\nconst historyId=\"\".concat(Date.now(),\"-\").concat(Math.floor(Math.random()*100000));// Push a placeholder entry into history immediately so UI shows right away\nconst placeholder=_objectSpread(_objectSpread({},movie),{},{video_url:movie.video_url||null,poster_url:movie.poster_url||null,loadingTrailer:!movie.video_url,historyId});setMovieHistory(prev=>[...prev,placeholder]);// Record a view interaction for personalization (best-effort)\ntry{const stored=localStorage.getItem('user');const user=stored?JSON.parse(stored):null;if(user&&user.userId){fetch(\"\".concat(API_BASE,\"/interactions\"),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.userId,movieId:movie.id,action:'view'})}).catch(()=>{});}}catch(e){}// Fetch user's last interaction for this movie to restore like/dislike state\ntry{const stored=localStorage.getItem('user');const user=stored?JSON.parse(stored):null;if(user&&user.userId){// Check watchlist status from localStorage\ntry{const cacheKey=\"watchlist_\".concat(user.userId);const cached=localStorage.getItem(cacheKey);if(cached){const watchlistData=JSON.parse(cached);const isInWatchlist=watchlistData.some(m=>m.id===movie.id);setWatchlist(prev=>_objectSpread(_objectSpread({},prev),{},{[movie.id]:isInWatchlist}));}}catch(e){console.warn('Failed to check watchlist status:',e);}// Check local cache first\ntry{const cacheKey=\"likes_cache_\".concat(user.userId);const raw=localStorage.getItem(cacheKey);if(raw){const map=JSON.parse(raw);if(map&&map[movie.id]){const action=map[movie.id];if(action==='like'){setLikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movie.id]:true}));setDislikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movie.id]:false}));}else if(action==='dislike'){setDislikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movie.id]:true}));setLikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movie.id]:false}));}// skip remote fetch when cached\nreturn;}}}catch(e){// ignore cache failures\n}// remote fetch with limit=1 for speed\nfetch(\"\".concat(API_BASE,\"/interactions?user_id=\").concat(encodeURIComponent(user.userId),\"&movie_id=\").concat(movie.id,\"&limit=1\")).then(res=>res.ok?res.json():null).then(data=>{if(data&&data.results&&data.results.length>0){const last=data.results[0];if(last.action==='like'){setLikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movie.id]:true}));setDislikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movie.id]:false}));// update cache\ntry{const cacheKey=\"likes_cache_\".concat(user.userId);const raw=localStorage.getItem(cacheKey);const map=raw?JSON.parse(raw):{};map[movie.id]='like';localStorage.setItem(cacheKey,JSON.stringify(map));}catch(e){}}else if(last.action==='dislike'){setDislikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movie.id]:true}));setLikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movie.id]:false}));try{const cacheKey=\"likes_cache_\".concat(user.userId);const raw=localStorage.getItem(cacheKey);const map=raw?JSON.parse(raw):{};map[movie.id]='dislike';localStorage.setItem(cacheKey,JSON.stringify(map));}catch(e){}}}}).catch(()=>{});}}catch(e){}// Fetch and update trailer/poster asynchronously if we don't already have a video\nif(!movie.video_url){try{const resp=await fetch(\"\".concat(API_BASE,\"/movies/\").concat(movie.id,\"/trailer\"));console.debug('trailer endpoint response status',resp.status);if(resp.ok){const data=await resp.json();console.debug('trailer endpoint data',data);// Update the history entry by historyId\nsetMovieHistory(prev=>prev.map(entry=>{if(entry.historyId===historyId){return _objectSpread(_objectSpread({},entry),{},{video_url:(data===null||data===void 0?void 0:data.video_url)||entry.video_url,poster_url:(data===null||data===void 0?void 0:data.poster_url)||entry.poster_url,loadingTrailer:false});}return entry;}));}else{// still mark as not loading and provide fallback\nsetMovieHistory(prev=>prev.map(entry=>entry.historyId===historyId?_objectSpread(_objectSpread({},entry),{},{loadingTrailer:false}):entry));}}catch(err){console.error('Failed to fetch trailer endpoint:',err);setMovieHistory(prev=>prev.map(entry=>entry.historyId===historyId?_objectSpread(_objectSpread({},entry),{},{loadingTrailer:false}):entry));}// If after the fetch there's still no video_url, set a YouTube search URL fallback (but don't embed it)\nsetMovieHistory(prev=>prev.map(entry=>{if(entry.historyId!==historyId)return entry;if(entry.video_url)return entry;try{const title=entry.title||'';const year=entry.year?\" \".concat(entry.year):'';const query=encodeURIComponent(\"\".concat(title).concat(year,\" trailer\"));return _objectSpread(_objectSpread({},entry),{},{// store a search URL (we will open it in new tab rather than embedding)\nvideo_url:\"https://www.youtube.com/results?search_query=\".concat(query)});}catch(e){return entry;}}));}// Fetch similar movies in background (non-blocking)\nif(!similarMoviesCache[movie.id]){fetch(\"\".concat(API_BASE,\"/recommendations?rec_type=content&movie_id=\").concat(movie.id,\"&n=10\")).then(response=>response.ok?response.json():null).then(data=>{if(data&&data.results){setSimilarMoviesCache(prev=>_objectSpread(_objectSpread({},prev),{},{[movie.id]:data.results}));}}).catch(err=>console.error('Failed to fetch similar movies:',err));}// Fetch latest comments for this movie (background)\ntry{fetch(\"\".concat(API_BASE,\"/movies/\").concat(movie.id,\"/comments?limit=20\")).then(res=>res.ok?res.json():null).then(data=>{if(data&&data.comments){setComments(data.comments);setShowAllComments(false);}}).catch(()=>{});}catch(e){}};const handleLike=async()=>{if(!currentMovie)return;try{// Persist interaction to server with userId\nconst stored=localStorage.getItem('user');const user=stored?JSON.parse(stored):null;if(user&&user.userId){await fetch(\"\".concat(API_BASE,\"/interactions\"),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.userId,movieId:currentMovie.id,action:'like'})});}else{await fetch(\"\".concat(API_BASE,\"/movies/\").concat(currentMovie.id,\"/like\"),{method:'POST'});}const movieId=currentMovie.id;const isCurrentlyLiked=likes[movieId];setLikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movieId]:!isCurrentlyLiked}));// If clicking like, remove dislike\nif(!isCurrentlyLiked){setDislikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movieId]:false}));// Save to cache\nif(user&&user.userId){try{const cacheKey=\"likes_cache_\".concat(user.userId);const raw=localStorage.getItem(cacheKey);const map=raw?JSON.parse(raw):{};map[movieId]='like';localStorage.setItem(cacheKey,JSON.stringify(map));}catch(e){console.warn('Failed to save like cache:',e);}}}else{// Remove from cache if toggling off\nif(user&&user.userId){try{const cacheKey=\"likes_cache_\".concat(user.userId);const raw=localStorage.getItem(cacheKey);const map=raw?JSON.parse(raw):{};delete map[movieId];localStorage.setItem(cacheKey,JSON.stringify(map));}catch(e){console.warn('Failed to update like cache:',e);}}}}catch(err){console.error('Failed to like movie:',err);}};const handleDislike=async()=>{if(!currentMovie)return;try{const stored=localStorage.getItem('user');const user=stored?JSON.parse(stored):null;if(user&&user.userId){await fetch(\"\".concat(API_BASE,\"/interactions\"),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.userId,movieId:currentMovie.id,action:'dislike'})});}else{await fetch(\"\".concat(API_BASE,\"/movies/\").concat(currentMovie.id,\"/dislike\"),{method:'POST'});}const movieId=currentMovie.id;const isCurrentlyDisliked=dislikes[movieId];setDislikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movieId]:!isCurrentlyDisliked}));// If clicking dislike, remove like\nif(!isCurrentlyDisliked){setLikes(prev=>_objectSpread(_objectSpread({},prev),{},{[movieId]:false}));// Save to cache\nif(user&&user.userId){try{const cacheKey=\"likes_cache_\".concat(user.userId);const raw=localStorage.getItem(cacheKey);const map=raw?JSON.parse(raw):{};map[movieId]='dislike';localStorage.setItem(cacheKey,JSON.stringify(map));}catch(e){console.warn('Failed to save dislike cache:',e);}}}else{// Remove from cache if toggling off\nif(user&&user.userId){try{const cacheKey=\"likes_cache_\".concat(user.userId);const raw=localStorage.getItem(cacheKey);const map=raw?JSON.parse(raw):{};delete map[movieId];localStorage.setItem(cacheKey,JSON.stringify(map));}catch(e){console.warn('Failed to update dislike cache:',e);}}}}catch(err){console.error('Failed to dislike movie:',err);}};const handleWatchlist=async()=>{if(!currentMovie)return;try{const stored=localStorage.getItem('user');const user=stored?JSON.parse(stored):null;const userId=(user===null||user===void 0?void 0:user.userId)||'Anonymous';const isInWatchlist=watchlist[currentMovie.id];const action=isInWatchlist?'remove_from_watchlist':'add_to_watchlist';await fetch(\"\".concat(API_BASE,\"/watchlist\"),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:userId,movieId:currentMovie.id,action:action})});setWatchlist(prev=>_objectSpread(_objectSpread({},prev),{},{[currentMovie.id]:!isInWatchlist}));// Update localStorage cache\ntry{const cacheKey=\"watchlist_\".concat(userId);const cached=localStorage.getItem(cacheKey);let watchlistData=cached?JSON.parse(cached):[];if(isInWatchlist){watchlistData=watchlistData.filter(m=>m.id!==currentMovie.id);}else{watchlistData.push(currentMovie);}localStorage.setItem(cacheKey,JSON.stringify(watchlistData));}catch(e){console.warn('Failed to update watchlist cache:',e);}}catch(err){console.error('Failed to update watchlist:',err);}};// Quick submit rating (1-5 sao) without opening modal\nconst handleRate=async star=>{if(!currentMovie)return;try{const stored=localStorage.getItem('user');const user=stored?JSON.parse(stored):null;const payload={rating:star,review_text:'',username:user&&user.userId?user.userId:'Anonymous'};const response=await fetch(\"\".concat(API_BASE,\"/movies/\").concat(currentMovie.id,\"/review\"),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(response.ok){setReviewRating(star);alert('Cảm ơn bạn đã đánh giá!');}else{alert('Gửi đánh giá thất bại');}}catch(err){console.error('Failed to submit rating:',err);alert('Lỗi khi gửi đánh giá. Vui lòng thử lại!');}};const handleSubmitComment=async()=>{if(!currentMovie)return;try{const stored=localStorage.getItem('user');const user=stored?JSON.parse(stored):null;const payload={userId:user&&user.userId?user.userId:'Anonymous',comment:commentText||''};// If we have a registered display name locally, ensure server has the user metadata\nif(user&&user.userId&&(user.name||user.email)){try{await fetch(\"\".concat(API_BASE,\"/users\"),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.userId,metadata:JSON.stringify({name:user.name,email:user.email})})});}catch(e){// best-effort - ignore errors\n}}if(!payload.comment.trim()){alert('Vui lòng nhập bình luận');return;}const resp=await fetch(\"\".concat(API_BASE,\"/movies/\").concat(currentMovie.id,\"/comment\"),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(resp.ok){const data=await resp.json();// prepend local comment to list and include display_name for immediate UI\nconst displayName=user&&(user.name||user.displayName)||payload.userId;setComments(prev=>[{id:Date.now(),movieId:currentMovie.id,userId:payload.userId,display_name:displayName,comment:payload.comment,timestamp:new Date().toISOString()},...prev]);setCommentText('');}else{alert('Gửi bình luận thất bại');}}catch(e){console.error('Failed to submit comment',e);alert('Lỗi khi gửi bình luận');}};const goBack=()=>{if(movieHistory.length>1){// Remove current movie from history\nconst newHistory=[...movieHistory];newHistory.pop();setMovieHistory(newHistory);}else if(movieHistory.length===1){// Return to recommendations list\nsetMovieHistory([]);}};// Movie card component\nconst MovieCard=_ref2=>{var _movie$overview;let{movie,isCompact}=_ref2;return/*#__PURE__*/_jsxs(\"div\",{className:isCompact?styles.movieCardCompact:styles.movieCard,onClick:()=>openMovie(movie),children:[/*#__PURE__*/_jsxs(\"div\",{className:styles.moviePosterContainer,children:[movie.poster_url?/*#__PURE__*/_jsx(\"img\",{src:movie.poster_url,alt:movie.title,className:styles.moviePoster,loading:\"lazy\"}):/*#__PURE__*/_jsx(\"div\",{className:styles.moviePosterPlaceholder,children:/*#__PURE__*/_jsx(\"p\",{children:\"Kh\\xF4ng c\\xF3 Poster\"})}),/*#__PURE__*/_jsx(\"div\",{className:styles.playOverlay,children:\"\\u25B6\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:styles.movieDetails,children:[/*#__PURE__*/_jsxs(\"h3\",{className:styles.movieTitle,children:[movie.title,\" \",movie.year>0&&\"(\".concat(movie.year,\")\")]}),/*#__PURE__*/_jsxs(\"p\",{className:styles.rating,children:[\"\\u2B50 \",movie.vote_average||'N/A',\"/10\"]}),!isCompact&&/*#__PURE__*/_jsxs(\"p\",{className:styles.overview,children:[(_movie$overview=movie.overview)===null||_movie$overview===void 0?void 0:_movie$overview.substring(0,100),\"...\"]})]})]});};const handleGetRecommendations=async()=>{setLoading(true);setError('');setRecommendations([]);try{// Fast-path: load from cache first to render immediately\nconst stored=localStorage.getItem('user');const user=stored?JSON.parse(stored):null;const cacheKey=\"cached_recs_\".concat(recType,\"_\").concat(user&&user.userId?user.userId:'public');try{const raw=localStorage.getItem(cacheKey);if(raw){const parsed=JSON.parse(raw);const movies=parsed.results||[];if(movies.length>0){setRecommendations(movies);setLoading(false);}}}catch(e){}const userParam=user&&user.userId?\"&user_id=\".concat(encodeURIComponent(user.userId)):'';const url=\"\".concat(API_BASE,\"/recommendations?rec_type=\").concat(encodeURIComponent(recType),\"&n=10\").concat(userParam);const response=await fetch(url);if(!response.ok){const errorText=await response.text();throw new Error(\"L\\u1ED7i l\\u1EA5y g\\u1EE3i \\xFD: \".concat(response.status,\" - \").concat(errorText.substring(0,200)));}const data=await response.json();const results=data.results||[];// update UI and cache\nsetRecommendations(results);try{localStorage.setItem(cacheKey,JSON.stringify({ts:Date.now(),results}));}catch(e){}if(results.length===0)setError('Không tìm thấy gợi ý nào.');}catch(err){setError(\"Th\\u1EA5t b\\u1EA1i khi k\\u1EBFt n\\u1ED1i: \".concat(err.message));}finally{setLoading(false);}};useEffect(()=>{handleGetRecommendations();},[]);// Load YouTube IFrame API\nuseEffect(()=>{if(!window.YT){const tag=document.createElement('script');tag.src='https://www.youtube.com/iframe_api';const firstScriptTag=document.getElementsByTagName('script')[0];firstScriptTag.parentNode.insertBefore(tag,firstScriptTag);}},[]);// Auto-save progress every 10 seconds when playing\nuseEffect(()=>{if(!currentMovie||!player)return;const interval=setInterval(()=>{try{if(player&&typeof player.getCurrentTime==='function'&&typeof player.getDuration==='function'){const currentTime=player.getCurrentTime();const duration=player.getDuration();if(currentTime>0&&duration>0){saveVideoProgress(currentMovie.id,currentTime,duration);}}}catch(e){// Player might not be ready\n}},10000);// Save every 10 seconds\nreturn()=>clearInterval(interval);},[currentMovie,player]);// Save progress when user leaves page\nuseEffect(()=>{const handleBeforeUnload=()=>{if(currentMovie&&player){try{const currentTime=player.getCurrentTime();const duration=player.getDuration();if(currentTime>0){saveVideoProgress(currentMovie.id,currentTime,duration);}}catch(e){}}};window.addEventListener('beforeunload',handleBeforeUnload);return()=>window.removeEventListener('beforeunload',handleBeforeUnload);},[currentMovie,player]);return/*#__PURE__*/_jsx(\"div\",{className:styles.mainContent,children:!currentMovie?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"header\",{className:styles.header,children:/*#__PURE__*/_jsx(\"h1\",{className:styles.pageHeader,children:\"\\u2B50 \\u0110\\u1EC1 Xu\\u1EA5t Phim Cho B\\u1EA1n\"})}),error&&/*#__PURE__*/_jsx(\"div\",{className:styles.error,children:error}),loading&&recommendations.length===0&&/*#__PURE__*/_jsxs(\"div\",{className:styles.recommendationsContainer,children:[/*#__PURE__*/_jsx(\"div\",{className:styles.skeletonTitle}),/*#__PURE__*/_jsx(\"div\",{className:styles.movieRow,children:Array.from({length:6}).map((_,i)=>/*#__PURE__*/_jsxs(\"div\",{className:styles.movieCardSkeleton,children:[/*#__PURE__*/_jsx(\"div\",{className:styles.skeletonPoster}),/*#__PURE__*/_jsx(\"div\",{className:styles.skeletonText}),/*#__PURE__*/_jsx(\"div\",{className:styles.skeletonText,style:{width:'60%'}})]},i))})]}),recommendations.length>0&&/*#__PURE__*/_jsxs(\"div\",{className:styles.recommendationsContainer,children:[/*#__PURE__*/_jsxs(\"h2\",{className:styles.rowTitle,children:[\"\\uD83C\\uDFAC \\u0110\\u1EC1 xu\\u1EA5t h\\xE0ng \\u0111\\u1EA7u (\",recommendations.length,\")\"]}),/*#__PURE__*/_jsx(\"div\",{className:styles.movieRow,children:recommendations.map((movie,idx)=>/*#__PURE__*/_jsx(MovieCard,{movie:movie},idx))})]})]}):/*#__PURE__*/_jsxs(\"div\",{className:styles.moviePlayerContainer,children:[/*#__PURE__*/_jsx(\"button\",{className:styles.backButton,onClick:goBack,children:\"\\u2190 Quay l\\u1EA1i\"}),/*#__PURE__*/_jsxs(\"div\",{className:styles.playerSection,children:[/*#__PURE__*/_jsx(\"div\",{className:styles.videoPlayer,children:(()=>{const embed=currentMovie.video_url?getYouTubeEmbedUrl(currentMovie.video_url)||currentMovie.video_url:null;const searchEmbed=embed?isSearchEmbed(embed):false;// If we have a proper embed and it's not a search-type embed, show iframe\nif(embed&&!searchEmbed&&embed.includes('/embed')){const sep=embed.includes('?')?'&':'?';const savedProgress=videoProgress[currentMovie.id];const startTime=(savedProgress===null||savedProgress===void 0?void 0:savedProgress.timestamp)>5?savedProgress.timestamp:0;const startParam=startTime>0?\"&start=\".concat(startTime):'';return/*#__PURE__*/_jsx(\"iframe\",{id:\"youtube-player-\".concat(currentMovie.id),width:\"100%\",height:\"100%\",title:currentMovie.title,frameBorder:\"0\",allow:\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\",allowFullScreen:true,referrerPolicy:\"strict-origin-when-cross-origin\",src:\"\".concat(embed).concat(sep,\"autoplay=1&mute=0&rel=0&modestbranding=1&enablejsapi=1\").concat(startParam),onLoad:()=>{// Wait for YouTube IFrame API to be ready before initializing\nconst initPlayer=()=>{if(window.YT&&window.YT.Player){try{const ytPlayer=new window.YT.Player(\"youtube-player-\".concat(currentMovie.id),{events:{'onReady':event=>{console.log('YouTube player ready');setPlayer(event.target);playerRef.current=event.target;// Seek to saved position if available\nif(startTime>5){setTimeout(()=>{try{event.target.seekTo(startTime,true);}catch(e){console.warn('Failed to seek:',e);}},1000);}// Auto-save progress every 10 seconds\nconst saveInterval=setInterval(()=>{try{const player=playerRef.current;if(player&&typeof player.getCurrentTime==='function'){const currentTime=player.getCurrentTime();const duration=player.getDuration();if(currentTime>0){saveVideoProgress(currentMovie.id,currentTime,duration);}}}catch(e){}},10000);// Clear interval when player is destroyed\nreturn()=>clearInterval(saveInterval);},'onStateChange':event=>{// Save when paused\nif(event.data===window.YT.PlayerState.PAUSED){try{const currentTime=event.target.getCurrentTime();const duration=event.target.getDuration();saveVideoProgress(currentMovie.id,currentTime,duration);}catch(e){}}}}});}catch(e){console.warn('Failed to initialize YouTube player:',e);}}else{// YT API not ready yet, try again in 500ms\nsetTimeout(initPlayer,500);}};// Start initialization with slight delay to ensure iframe is ready\nsetTimeout(initPlayer,200);}});}// Otherwise show poster with message + button to open YouTube search\nif(currentMovie.poster_url){return/*#__PURE__*/_jsxs(\"div\",{className:styles.noPoster,children:[/*#__PURE__*/_jsx(\"img\",{src:currentMovie.poster_url,alt:currentMovie.title,style:{width:'100%',height:'100%',objectFit:'contain'}}),/*#__PURE__*/_jsx(\"div\",{className:styles.noVideoOverlay,children:currentMovie.loadingTrailer?'Đang tải phim...':'Trailer không khả dụng'}),/*#__PURE__*/_jsx(\"div\",{style:{position:'absolute',right:12,bottom:12},children:/*#__PURE__*/_jsx(\"button\",{className:styles.openYouTubeBtn,onClick:()=>window.open(currentMovie.video_url||\"https://www.youtube.com/results?search_query=\".concat(encodeURIComponent(currentMovie.title||'')),'_blank'),children:\"M\\u1EDF trailer tr\\xEAn YouTube\"})})]});}return/*#__PURE__*/_jsx(\"div\",{className:styles.noVideo,children:currentMovie.loadingTrailer?'Đang tải phim...':'Không có trailer'});})()}),/*#__PURE__*/_jsxs(\"div\",{className:styles.movieInfo,children:[/*#__PURE__*/_jsxs(\"h1\",{className:styles.movieInfoTitle,children:[currentMovie.title,\" \",currentMovie.year>0&&\"(\".concat(currentMovie.year,\")\")]}),/*#__PURE__*/_jsxs(\"div\",{className:styles.movieMeta,children:[/*#__PURE__*/_jsxs(\"span\",{className:styles.movieRating,children:[\"\\u2B50 \",currentMovie.vote_average||'N/A',\"/10\"]}),/*#__PURE__*/_jsxs(\"span\",{className:styles.movieVotes,children:[\"(\",currentMovie.vote_count||0,\" votes)\"]})]}),/*#__PURE__*/_jsx(\"p\",{className:styles.movieDescription,children:currentMovie.overview}),/*#__PURE__*/_jsxs(\"div\",{className:styles.interactionButtons,children:[/*#__PURE__*/_jsx(\"button\",{className:\"\".concat(styles.likeBtn,\" \").concat(likes[currentMovie.id]?styles.active:''),onClick:handleLike,title:\"Th\\xEDch phim n\\xE0y\",children:\"\\uD83D\\uDC4D Th\\xEDch\"}),/*#__PURE__*/_jsx(\"button\",{className:\"\".concat(styles.dislikeBtn,\" \").concat(dislikes[currentMovie.id]?styles.active:''),onClick:handleDislike,title:\"Kh\\xF4ng th\\xEDch\",children:\"\\uD83D\\uDC4E Kh\\xF4ng th\\xEDch\"}),/*#__PURE__*/_jsx(\"button\",{className:\"\".concat(styles.watchlistBtn,\" \").concat(watchlist[currentMovie.id]?styles.active:''),onClick:handleWatchlist,title:watchlist[currentMovie.id]?\"Xóa khỏi danh sách\":\"Lưu vào danh sách\",children:watchlist[currentMovie.id]?'✓ Đã lưu':'+ Lưu'}),/*#__PURE__*/_jsx(\"div\",{className:styles.ratingInline,children:[1,2,3,4,5].map(star=>/*#__PURE__*/_jsx(\"button\",{className:\"\".concat(styles.star,\" \").concat((hoverRating||reviewRating)>=star?styles.starActive:''),onClick:()=>handleRate(star),onMouseEnter:()=>setHoverRating(star),onMouseLeave:()=>setHoverRating(0),title:\"\\u0110\\xE1nh gi\\xE1 \".concat(star,\" sao\"),children:\"\\u2B50\"},star))})]}),/*#__PURE__*/_jsxs(\"div\",{className:styles.commentsSection,children:[/*#__PURE__*/_jsx(\"h3\",{children:\"B\\xECnh lu\\u1EADn\"}),/*#__PURE__*/_jsxs(\"div\",{className:styles.commentForm,children:[/*#__PURE__*/_jsx(\"textarea\",{value:commentText,onChange:e=>setCommentText(e.target.value),placeholder:\"Vi\\u1EBFt b\\xECnh lu\\u1EADn...\",rows:3}),/*#__PURE__*/_jsx(\"button\",{className:styles.submitBtn,onClick:handleSubmitComment,children:\"G\\u1EEDi\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:styles.commentList,children:[comments.length===0&&/*#__PURE__*/_jsx(\"div\",{children:\"Ch\\u01B0a c\\xF3 b\\xECnh lu\\u1EADn n\\xE0o.\"}),comments.length>0&&(showAllComments?comments:comments.slice(0,2)).map(c=>/*#__PURE__*/_jsxs(\"div\",{className:styles.commentItem,children:[/*#__PURE__*/_jsxs(\"div\",{className:styles.commentMeta,children:[/*#__PURE__*/_jsx(\"strong\",{children:c.display_name||c.userId}),\" \\u2022 \",/*#__PURE__*/_jsx(\"span\",{className:styles.commentTime,children:new Date(c.timestamp).toLocaleString()})]}),/*#__PURE__*/_jsx(\"div\",{className:styles.commentText,children:c.comment})]},c.id)),comments.length>2&&/*#__PURE__*/_jsx(\"div\",{className:styles.commentToggle,children:/*#__PURE__*/_jsx(\"button\",{className:styles.smallBtn,onClick:()=>setShowAllComments(prev=>!prev),children:showAllComments?\"R\\xFAt g\\u1ECDn\":\"Xem th\\xEAm \".concat(comments.length-2,\" b\\xECnh lu\\u1EADn\")})})]})]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:styles.similarMoviesSection,children:[/*#__PURE__*/_jsx(\"h2\",{className:styles.sectionTitle,children:\"G\\u1EE3i \\xFD cho b\\u1EA1n\"}),similarMovies.length>0?/*#__PURE__*/_jsx(\"div\",{className:styles.similarMoviesGrid,children:similarMovies.map((movie,idx)=>/*#__PURE__*/_jsx(MovieCard,{movie:movie,isCompact:true},idx))}):/*#__PURE__*/_jsx(\"div\",{className:styles.loadingMovies,children:\"\\u0110ang t\\u1EA3i...\"})]}),/*#__PURE__*/_jsx(\"div\",{style:{marginTop:12},children:/*#__PURE__*/_jsx(\"button\",{className:styles.openYouTubeBtn,onClick:()=>{const title=(currentMovie===null||currentMovie===void 0?void 0:currentMovie.title)||'';const year=currentMovie!==null&&currentMovie!==void 0&&currentMovie.year?\" \".concat(currentMovie.year):'';const query=encodeURIComponent(\"\".concat(title).concat(year,\" trailer\"));window.open(\"https://www.youtube.com/results?search_query=\".concat(query),'_blank');},children:\"M\\u1EDF trailer tr\\xEAn YouTube\"})})]})});}","map":{"version":3,"names":["React","useState","useEffect","styles","API_BASE","MovieCardSkeleton","jsx","_jsx","jsxs","_jsxs","Fragment","_Fragment","RecommendationsPage","_ref","onBack","initialMovie","recType","recommendations","setRecommendations","loading","setLoading","error","setError","movieHistory","setMovieHistory","similarMoviesCache","setSimilarMoviesCache","likes","setLikes","dislikes","setDislikes","watchlist","setWatchlist","reviewRating","setReviewRating","comments","setComments","commentText","setCommentText","showAllComments","setShowAllComments","hoverRating","setHoverRating","videoProgress","setVideoProgress","player","setPlayer","playerRef","useRef","currentMovie","length","similarMovies","id","saved","localStorage","getItem","JSON","parse","e","console","warn","stored","user","userId","cacheKey","concat","cached","watchlistData","watchlistMap","forEach","movie","likesCacheKey","likesCache","likesMap","newLikes","newDislikes","Object","keys","movieId","action","last","openMovie","getYouTubeEmbedUrl","url","includes","u","URL","hostname","replace","toString","urlObj","videoId","searchParams","get","pathname","slice","split","isSearchEmbed","params","saveVideoProgress","timestamp","duration","undefined","newProgress","_objectSpread","Math","floor","savedAt","Date","now","setItem","stringify","fetch","method","headers","body","user_id","movie_id","debug","title","historyId","random","placeholder","video_url","poster_url","loadingTrailer","prev","catch","isInWatchlist","some","m","raw","map","encodeURIComponent","then","res","ok","json","data","results","resp","status","entry","err","year","query","response","handleLike","isCurrentlyLiked","handleDislike","isCurrentlyDisliked","handleWatchlist","filter","push","handleRate","star","payload","rating","review_text","username","alert","handleSubmitComment","comment","name","email","metadata","trim","displayName","display_name","toISOString","goBack","newHistory","pop","MovieCard","_ref2","_movie$overview","isCompact","className","movieCardCompact","movieCard","onClick","children","moviePosterContainer","src","alt","moviePoster","moviePosterPlaceholder","playOverlay","movieDetails","movieTitle","vote_average","overview","substring","handleGetRecommendations","parsed","movies","userParam","errorText","text","Error","ts","message","window","YT","tag","document","createElement","firstScriptTag","getElementsByTagName","parentNode","insertBefore","interval","setInterval","getCurrentTime","getDuration","currentTime","clearInterval","handleBeforeUnload","addEventListener","removeEventListener","mainContent","header","pageHeader","recommendationsContainer","skeletonTitle","movieRow","Array","from","_","i","movieCardSkeleton","skeletonPoster","skeletonText","style","width","rowTitle","idx","moviePlayerContainer","backButton","playerSection","videoPlayer","embed","searchEmbed","sep","savedProgress","startTime","startParam","height","frameBorder","allow","allowFullScreen","referrerPolicy","onLoad","initPlayer","Player","ytPlayer","events","event","log","target","current","setTimeout","seekTo","saveInterval","PlayerState","PAUSED","noPoster","objectFit","noVideoOverlay","position","right","bottom","openYouTubeBtn","open","noVideo","movieInfo","movieInfoTitle","movieMeta","movieRating","movieVotes","vote_count","movieDescription","interactionButtons","likeBtn","active","dislikeBtn","watchlistBtn","ratingInline","starActive","onMouseEnter","onMouseLeave","commentsSection","commentForm","value","onChange","rows","submitBtn","commentList","c","commentItem","commentMeta","commentTime","toLocaleString","commentToggle","smallBtn","similarMoviesSection","sectionTitle","similarMoviesGrid","loadingMovies","marginTop"],"sources":["D:/cn/phim/frontend/src/pages/RecommendationsPage.js"],"sourcesContent":["import React, { useState, useEffect } from 'react';\r\nimport styles from './RecommendationsPage.module.css';\r\nimport { API_BASE } from '../config';\r\nimport { MovieCardSkeleton } from '../components/MovieSkeleton';\r\n\r\nexport default function RecommendationsPage({ onBack, initialMovie }) {\r\n    const [recType] = useState('hybrid');\r\n    const [recommendations, setRecommendations] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [error, setError] = useState('');\r\n    const [movieHistory, setMovieHistory] = useState([]); // Stack of viewed movies\r\n    const [similarMoviesCache, setSimilarMoviesCache] = useState({}); // Cache similar movies by movie ID\r\n    const [likes, setLikes] = useState({}); // Track liked movies\r\n    const [dislikes, setDislikes] = useState({}); // Track disliked movies\r\n    const [watchlist, setWatchlist] = useState({}); // Track watchlist movies\r\n    const [reviewRating, setReviewRating] = useState(0); // Review rating (1-5)\r\n    const [comments, setComments] = useState([]);\r\n    const [commentText, setCommentText] = useState('');\r\n    const [showAllComments, setShowAllComments] = useState(false);\r\n    const [hoverRating, setHoverRating] = useState(0); // Hover rating for preview\r\n    const [videoProgress, setVideoProgress] = useState({}); // Track video progress {movieId: {timestamp, duration}}\r\n    const [player, setPlayer] = useState(null); // YouTube player instance\r\n    const playerRef = React.useRef(null);\r\n    \r\n    const currentMovie = movieHistory.length > 0 ? movieHistory[movieHistory.length - 1] : null;\r\n    const similarMovies = currentMovie ? (similarMoviesCache[currentMovie.id] || []) : [];\r\n\r\n    // Load saved video progress from localStorage\r\n    useEffect(() => {\r\n        try {\r\n            const saved = localStorage.getItem('video_progress');\r\n            if (saved) {\r\n                setVideoProgress(JSON.parse(saved));\r\n            }\r\n        } catch (e) {\r\n            console.warn('Failed to load video progress:', e);\r\n        }\r\n    }, []);\r\n\r\n    // Load watchlist from localStorage on mount\r\n    useEffect(() => {\r\n        try {\r\n            const stored = localStorage.getItem('user');\r\n            const user = stored ? JSON.parse(stored) : null;\r\n            if (user?.userId) {\r\n                const cacheKey = `watchlist_${user.userId}`;\r\n                const cached = localStorage.getItem(cacheKey);\r\n                if (cached) {\r\n                    const watchlistData = JSON.parse(cached);\r\n                    const watchlistMap = {};\r\n                    watchlistData.forEach(movie => {\r\n                        watchlistMap[movie.id] = true;\r\n                    });\r\n                    setWatchlist(watchlistMap);\r\n                }\r\n                \r\n                // Load likes/dislikes from cache on mount\r\n                const likesCacheKey = `likes_cache_${user.userId}`;\r\n                const likesCache = localStorage.getItem(likesCacheKey);\r\n                if (likesCache) {\r\n                    const likesMap = JSON.parse(likesCache);\r\n                    const newLikes = {};\r\n                    const newDislikes = {};\r\n                    Object.keys(likesMap).forEach(movieId => {\r\n                        const action = likesMap[movieId];\r\n                        if (action === 'like') {\r\n                            newLikes[movieId] = true;\r\n                            newDislikes[movieId] = false;\r\n                        } else if (action === 'dislike') {\r\n                            newDislikes[movieId] = true;\r\n                            newLikes[movieId] = false;\r\n                        }\r\n                    });\r\n                    setLikes(newLikes);\r\n                    setDislikes(newDislikes);\r\n                }\r\n            }\r\n        } catch (e) {\r\n            console.warn('Failed to load user state:', e);\r\n        }\r\n    }, []);\r\n\r\n    // Load initial movie if provided (from HomePage click)\r\n    useEffect(() => {\r\n        if (initialMovie) {\r\n            // If history is empty or last movie differs, open the initial movie\r\n            const last = movieHistory.length > 0 ? movieHistory[movieHistory.length - 1] : null;\r\n            if (!last || last.id !== initialMovie.id) {\r\n                openMovie(initialMovie);\r\n            }\r\n        }\r\n    }, [initialMovie]);\r\n\r\n    const getYouTubeEmbedUrl = (url) => {\r\n        if (!url) return null;\r\n        \r\n        // Nếu là embed URL, trả về trực tiếp\r\n        if (url.includes('/embed')) {\r\n            // Nếu backend trả về URL embed, chuyển hostname sang youtube-nocookie để giảm khả năng bị block\r\n            try {\r\n                const u = new URL(url);\r\n                u.hostname = u.hostname.replace('www.youtube.com', 'www.youtube-nocookie.com').replace('youtube.com', 'www.youtube-nocookie.com');\r\n                return u.toString();\r\n            } catch (e) {\r\n                return url;\r\n            }\r\n        }\r\n        \r\n        // Nếu là watch URL, extract video ID\r\n        try {\r\n            const urlObj = new URL(url);\r\n            if (urlObj.hostname.includes('youtube.com') || urlObj.hostname.includes('www.youtube.com')) {\r\n                const videoId = urlObj.searchParams.get('v');\r\n                if (videoId) return `https://www.youtube-nocookie.com/embed/${videoId}`;\r\n            }\r\n            if (urlObj.hostname.includes('youtu.be')) {\r\n                const videoId = urlObj.pathname.slice(1).split('?')[0];\r\n                if (videoId) return `https://www.youtube-nocookie.com/embed/${videoId}`;\r\n            }\r\n        } catch (e) {\r\n            console.error('Error parsing YouTube URL:', e);\r\n            return null;\r\n        }\r\n        return null;\r\n    };\r\n\r\n    const isSearchEmbed = (url) => {\r\n        if (!url) return false;\r\n        try {\r\n            const u = new URL(url);\r\n            const params = u.searchParams;\r\n            if (params.get('listType') === 'search') return true;\r\n            // if it's an embed without a video id and contains 'list=' it's likely a search/embed playlist\r\n            if (u.pathname && u.pathname.includes('/embed') && params.get('list')) return true;\r\n            return false;\r\n        } catch (e) {\r\n            return false;\r\n        }\r\n    };\r\n\r\n    // Save video progress to localStorage and backend\r\n    const saveVideoProgress = async (movieId, timestamp, duration) => {\r\n        if (!movieId || timestamp === null || timestamp === undefined) return;\r\n        \r\n        // Save to state and localStorage\r\n        const newProgress = {\r\n            ...videoProgress,\r\n            [movieId]: { timestamp: Math.floor(timestamp), duration: Math.floor(duration || 0), savedAt: Date.now() }\r\n        };\r\n        setVideoProgress(newProgress);\r\n        \r\n        try {\r\n            localStorage.setItem('video_progress', JSON.stringify(newProgress));\r\n        } catch (e) {\r\n            console.warn('Failed to save progress to localStorage:', e);\r\n        }\r\n        \r\n        // Save to backend watch history\r\n        try {\r\n            const stored = localStorage.getItem('user');\r\n            const user = stored ? JSON.parse(stored) : null;\r\n            const userId = user?.userId || 'Anonymous';\r\n            \r\n            await fetch(`${API_BASE}/watch-history`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                    user_id: userId,\r\n                    movie_id: movieId,\r\n                    timestamp: Math.floor(timestamp),\r\n                    duration: Math.floor(duration || 0)\r\n                })\r\n            });\r\n        } catch (e) {\r\n            console.warn('Failed to save progress to backend:', e);\r\n        }\r\n    };\r\n\r\n    const openMovie = async (movie) => {\r\n        console.debug('openMovie called for', movie && movie.id, movie && movie.title);\r\n\r\n        // Create a unique id for this history entry so we can update it later\r\n        const historyId = `${Date.now()}-${Math.floor(Math.random() * 100000)}`;\r\n\r\n        // Push a placeholder entry into history immediately so UI shows right away\r\n        const placeholder = {\r\n            ...movie,\r\n            video_url: movie.video_url || null,\r\n            poster_url: movie.poster_url || null,\r\n            loadingTrailer: !movie.video_url,\r\n            historyId,\r\n        };\r\n\r\n        setMovieHistory(prev => ([...prev, placeholder]));\r\n\r\n        // Record a view interaction for personalization (best-effort)\r\n        try {\r\n            const stored = localStorage.getItem('user');\r\n            const user = stored ? JSON.parse(stored) : null;\r\n            if (user && user.userId) {\r\n                fetch(`${API_BASE}/interactions`, {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({ userId: user.userId, movieId: movie.id, action: 'view' })\r\n                }).catch(()=>{});\r\n            }\r\n        } catch (e) {}\r\n\r\n        // Fetch user's last interaction for this movie to restore like/dislike state\r\n        try {\r\n            const stored = localStorage.getItem('user');\r\n            const user = stored ? JSON.parse(stored) : null;\r\n            if (user && user.userId) {\r\n                // Check watchlist status from localStorage\r\n                try {\r\n                    const cacheKey = `watchlist_${user.userId}`;\r\n                    const cached = localStorage.getItem(cacheKey);\r\n                    if (cached) {\r\n                        const watchlistData = JSON.parse(cached);\r\n                        const isInWatchlist = watchlistData.some(m => m.id === movie.id);\r\n                        setWatchlist(prev => ({ ...prev, [movie.id]: isInWatchlist }));\r\n                    }\r\n                } catch (e) {\r\n                    console.warn('Failed to check watchlist status:', e);\r\n                }\r\n\r\n                // Check local cache first\r\n                try {\r\n                    const cacheKey = `likes_cache_${user.userId}`;\r\n                    const raw = localStorage.getItem(cacheKey);\r\n                    if (raw) {\r\n                        const map = JSON.parse(raw);\r\n                        if (map && map[movie.id]) {\r\n                            const action = map[movie.id];\r\n                            if (action === 'like') {\r\n                                setLikes(prev => ({ ...prev, [movie.id]: true }));\r\n                                setDislikes(prev => ({ ...prev, [movie.id]: false }));\r\n                            } else if (action === 'dislike') {\r\n                                setDislikes(prev => ({ ...prev, [movie.id]: true }));\r\n                                setLikes(prev => ({ ...prev, [movie.id]: false }));\r\n                            }\r\n                            // skip remote fetch when cached\r\n                            return;\r\n                        }\r\n                    }\r\n                } catch (e) {\r\n                    // ignore cache failures\r\n                }\r\n\r\n                // remote fetch with limit=1 for speed\r\n                fetch(`${API_BASE}/interactions?user_id=${encodeURIComponent(user.userId)}&movie_id=${movie.id}&limit=1`)\r\n                    .then(res => res.ok ? res.json() : null)\r\n                    .then(data => {\r\n                        if (data && data.results && data.results.length > 0) {\r\n                            const last = data.results[0];\r\n                            if (last.action === 'like') {\r\n                                setLikes(prev => ({ ...prev, [movie.id]: true }));\r\n                                setDislikes(prev => ({ ...prev, [movie.id]: false }));\r\n                                // update cache\r\n                                try {\r\n                                    const cacheKey = `likes_cache_${user.userId}`;\r\n                                    const raw = localStorage.getItem(cacheKey);\r\n                                    const map = raw ? JSON.parse(raw) : {};\r\n                                    map[movie.id] = 'like';\r\n                                    localStorage.setItem(cacheKey, JSON.stringify(map));\r\n                                } catch (e) {}\r\n                            } else if (last.action === 'dislike') {\r\n                                setDislikes(prev => ({ ...prev, [movie.id]: true }));\r\n                                setLikes(prev => ({ ...prev, [movie.id]: false }));\r\n                                try {\r\n                                    const cacheKey = `likes_cache_${user.userId}`;\r\n                                    const raw = localStorage.getItem(cacheKey);\r\n                                    const map = raw ? JSON.parse(raw) : {};\r\n                                    map[movie.id] = 'dislike';\r\n                                    localStorage.setItem(cacheKey, JSON.stringify(map));\r\n                                } catch (e) {}\r\n                            }\r\n                        }\r\n                    }).catch(()=>{});\r\n            }\r\n        } catch (e) {}\r\n\r\n        // Fetch and update trailer/poster asynchronously if we don't already have a video\r\n        if (!movie.video_url) {\r\n            try {\r\n                const resp = await fetch(`${API_BASE}/movies/${movie.id}/trailer`);\r\n                console.debug('trailer endpoint response status', resp.status);\r\n                if (resp.ok) {\r\n                    const data = await resp.json();\r\n                    console.debug('trailer endpoint data', data);\r\n                    // Update the history entry by historyId\r\n                    setMovieHistory(prev => prev.map(entry => {\r\n                        if (entry.historyId === historyId) {\r\n                            return {\r\n                                ...entry,\r\n                                video_url: data?.video_url || entry.video_url,\r\n                                poster_url: data?.poster_url || entry.poster_url,\r\n                                loadingTrailer: false,\r\n                            };\r\n                        }\r\n                        return entry;\r\n                    }));\r\n                } else {\r\n                    // still mark as not loading and provide fallback\r\n                    setMovieHistory(prev => prev.map(entry => entry.historyId === historyId ? ({...entry, loadingTrailer: false}) : entry));\r\n                }\r\n            } catch (err) {\r\n                console.error('Failed to fetch trailer endpoint:', err);\r\n                setMovieHistory(prev => prev.map(entry => entry.historyId === historyId ? ({...entry, loadingTrailer: false}) : entry));\r\n            }\r\n\r\n            // If after the fetch there's still no video_url, set a YouTube search URL fallback (but don't embed it)\r\n            setMovieHistory(prev => prev.map(entry => {\r\n                if (entry.historyId !== historyId) return entry;\r\n                if (entry.video_url) return entry;\r\n                try {\r\n                    const title = entry.title || '';\r\n                    const year = entry.year ? ` ${entry.year}` : '';\r\n                    const query = encodeURIComponent(`${title}${year} trailer`);\r\n                    return {\r\n                        ...entry,\r\n                        // store a search URL (we will open it in new tab rather than embedding)\r\n                        video_url: `https://www.youtube.com/results?search_query=${query}`\r\n                    };\r\n                } catch (e) {\r\n                    return entry;\r\n                }\r\n            }));\r\n        }\r\n\r\n        // Fetch similar movies in background (non-blocking)\r\n        if (!similarMoviesCache[movie.id]) {\r\n            fetch(`${API_BASE}/recommendations?rec_type=content&movie_id=${movie.id}&n=10`)\r\n                .then(response => response.ok ? response.json() : null)\r\n                .then(data => {\r\n                    if (data && data.results) {\r\n                        setSimilarMoviesCache(prev => ({\r\n                            ...prev,\r\n                            [movie.id]: data.results\r\n                        }));\r\n                    }\r\n                })\r\n                .catch(err => console.error('Failed to fetch similar movies:', err));\r\n        }\r\n\r\n        // Fetch latest comments for this movie (background)\r\n        try {\r\n            fetch(`${API_BASE}/movies/${movie.id}/comments?limit=20`)\r\n                .then(res => res.ok ? res.json() : null)\r\n                .then(data => {\r\n                    if (data && data.comments) {\r\n                        setComments(data.comments);\r\n                        setShowAllComments(false);\r\n                    }\r\n                }).catch(()=>{});\r\n        } catch (e) {}\r\n    };\r\n\r\n    const handleLike = async () => {\r\n        if (!currentMovie) return;\r\n        try {\r\n            // Persist interaction to server with userId\r\n            const stored = localStorage.getItem('user');\r\n            const user = stored ? JSON.parse(stored) : null;\r\n            if (user && user.userId) {\r\n                await fetch(`${API_BASE}/interactions`, {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({ userId: user.userId, movieId: currentMovie.id, action: 'like' })\r\n                });\r\n            } else {\r\n                await fetch(`${API_BASE}/movies/${currentMovie.id}/like`, { method: 'POST' });\r\n            }\r\n            const movieId = currentMovie.id;\r\n            const isCurrentlyLiked = likes[movieId];\r\n            \r\n            setLikes(prev => ({ ...prev, [movieId]: !isCurrentlyLiked }));\r\n            // If clicking like, remove dislike\r\n            if (!isCurrentlyLiked) {\r\n                setDislikes(prev => ({ ...prev, [movieId]: false }));\r\n                \r\n                // Save to cache\r\n                if (user && user.userId) {\r\n                    try {\r\n                        const cacheKey = `likes_cache_${user.userId}`;\r\n                        const raw = localStorage.getItem(cacheKey);\r\n                        const map = raw ? JSON.parse(raw) : {};\r\n                        map[movieId] = 'like';\r\n                        localStorage.setItem(cacheKey, JSON.stringify(map));\r\n                    } catch (e) {\r\n                        console.warn('Failed to save like cache:', e);\r\n                    }\r\n                }\r\n            } else {\r\n                // Remove from cache if toggling off\r\n                if (user && user.userId) {\r\n                    try {\r\n                        const cacheKey = `likes_cache_${user.userId}`;\r\n                        const raw = localStorage.getItem(cacheKey);\r\n                        const map = raw ? JSON.parse(raw) : {};\r\n                        delete map[movieId];\r\n                        localStorage.setItem(cacheKey, JSON.stringify(map));\r\n                    } catch (e) {\r\n                        console.warn('Failed to update like cache:', e);\r\n                    }\r\n                }\r\n            }\r\n        } catch (err) {\r\n            console.error('Failed to like movie:', err);\r\n        }\r\n    };\r\n\r\n    const handleDislike = async () => {\r\n        if (!currentMovie) return;\r\n        try {\r\n            const stored = localStorage.getItem('user');\r\n            const user = stored ? JSON.parse(stored) : null;\r\n            if (user && user.userId) {\r\n                await fetch(`${API_BASE}/interactions`, {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({ userId: user.userId, movieId: currentMovie.id, action: 'dislike' })\r\n                });\r\n            } else {\r\n                await fetch(`${API_BASE}/movies/${currentMovie.id}/dislike`, { method: 'POST' });\r\n            }\r\n            const movieId = currentMovie.id;\r\n            const isCurrentlyDisliked = dislikes[movieId];\r\n            \r\n            setDislikes(prev => ({ ...prev, [movieId]: !isCurrentlyDisliked }));\r\n            // If clicking dislike, remove like\r\n            if (!isCurrentlyDisliked) {\r\n                setLikes(prev => ({ ...prev, [movieId]: false }));\r\n                \r\n                // Save to cache\r\n                if (user && user.userId) {\r\n                    try {\r\n                        const cacheKey = `likes_cache_${user.userId}`;\r\n                        const raw = localStorage.getItem(cacheKey);\r\n                        const map = raw ? JSON.parse(raw) : {};\r\n                        map[movieId] = 'dislike';\r\n                        localStorage.setItem(cacheKey, JSON.stringify(map));\r\n                    } catch (e) {\r\n                        console.warn('Failed to save dislike cache:', e);\r\n                    }\r\n                }\r\n            } else {\r\n                // Remove from cache if toggling off\r\n                if (user && user.userId) {\r\n                    try {\r\n                        const cacheKey = `likes_cache_${user.userId}`;\r\n                        const raw = localStorage.getItem(cacheKey);\r\n                        const map = raw ? JSON.parse(raw) : {};\r\n                        delete map[movieId];\r\n                        localStorage.setItem(cacheKey, JSON.stringify(map));\r\n                    } catch (e) {\r\n                        console.warn('Failed to update dislike cache:', e);\r\n                    }\r\n                }\r\n            }\r\n        } catch (err) {\r\n            console.error('Failed to dislike movie:', err);\r\n        }\r\n    };\r\n\r\n    const handleWatchlist = async () => {\r\n        if (!currentMovie) return;\r\n        try {\r\n            const stored = localStorage.getItem('user');\r\n            const user = stored ? JSON.parse(stored) : null;\r\n            const userId = user?.userId || 'Anonymous';\r\n            \r\n            const isInWatchlist = watchlist[currentMovie.id];\r\n            const action = isInWatchlist ? 'remove_from_watchlist' : 'add_to_watchlist';\r\n            \r\n            await fetch(`${API_BASE}/watchlist`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ \r\n                    userId: userId, \r\n                    movieId: currentMovie.id, \r\n                    action: action \r\n                })\r\n            });\r\n            \r\n            setWatchlist(prev => ({ ...prev, [currentMovie.id]: !isInWatchlist }));\r\n            \r\n            // Update localStorage cache\r\n            try {\r\n                const cacheKey = `watchlist_${userId}`;\r\n                const cached = localStorage.getItem(cacheKey);\r\n                let watchlistData = cached ? JSON.parse(cached) : [];\r\n                \r\n                if (isInWatchlist) {\r\n                    watchlistData = watchlistData.filter(m => m.id !== currentMovie.id);\r\n                } else {\r\n                    watchlistData.push(currentMovie);\r\n                }\r\n                \r\n                localStorage.setItem(cacheKey, JSON.stringify(watchlistData));\r\n            } catch (e) {\r\n                console.warn('Failed to update watchlist cache:', e);\r\n            }\r\n        } catch (err) {\r\n            console.error('Failed to update watchlist:', err);\r\n        }\r\n    };\r\n\r\n    // Quick submit rating (1-5 sao) without opening modal\r\n    const handleRate = async (star) => {\r\n        if (!currentMovie) return;\r\n        try {\r\n            const stored = localStorage.getItem('user');\r\n            const user = stored ? JSON.parse(stored) : null;\r\n            const payload = {\r\n                rating: star,\r\n                review_text: '',\r\n                username: user && user.userId ? user.userId : 'Anonymous'\r\n            };\r\n            const response = await fetch(`${API_BASE}/movies/${currentMovie.id}/review`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify(payload)\r\n            });\r\n            if (response.ok) {\r\n                setReviewRating(star);\r\n                alert('Cảm ơn bạn đã đánh giá!');\r\n            } else {\r\n                alert('Gửi đánh giá thất bại');\r\n            }\r\n        } catch (err) {\r\n            console.error('Failed to submit rating:', err);\r\n            alert('Lỗi khi gửi đánh giá. Vui lòng thử lại!');\r\n        }\r\n    };\r\n\r\n    const handleSubmitComment = async () => {\r\n        if (!currentMovie) return;\r\n        try {\r\n            const stored = localStorage.getItem('user');\r\n            const user = stored ? JSON.parse(stored) : null;\r\n            const payload = {\r\n                userId: user && user.userId ? user.userId : 'Anonymous',\r\n                comment: commentText || ''\r\n            };\r\n            // If we have a registered display name locally, ensure server has the user metadata\r\n            if (user && user.userId && (user.name || user.email)) {\r\n                try {\r\n                    await fetch(`${API_BASE}/users`, {\r\n                        method: 'POST',\r\n                        headers: { 'Content-Type': 'application/json' },\r\n                        body: JSON.stringify({ userId: user.userId, metadata: JSON.stringify({ name: user.name, email: user.email }) })\r\n                    });\r\n                } catch (e) {\r\n                    // best-effort - ignore errors\r\n                }\r\n            }\r\n            if (!payload.comment.trim()) {\r\n                alert('Vui lòng nhập bình luận');\r\n                return;\r\n            }\r\n            const resp = await fetch(`${API_BASE}/movies/${currentMovie.id}/comment`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify(payload)\r\n            });\r\n            if (resp.ok) {\r\n                const data = await resp.json();\r\n                // prepend local comment to list and include display_name for immediate UI\r\n                const displayName = (user && (user.name || user.displayName)) || payload.userId;\r\n                setComments(prev => ([{ id: Date.now(), movieId: currentMovie.id, userId: payload.userId, display_name: displayName, comment: payload.comment, timestamp: new Date().toISOString() }, ...prev]));\r\n                setCommentText('');\r\n            } else {\r\n                alert('Gửi bình luận thất bại');\r\n            }\r\n        } catch (e) {\r\n            console.error('Failed to submit comment', e);\r\n            alert('Lỗi khi gửi bình luận');\r\n        }\r\n    };\r\n\r\n    const goBack = () => {\r\n        if (movieHistory.length > 1) {\r\n            // Remove current movie from history\r\n            const newHistory = [...movieHistory];\r\n            newHistory.pop();\r\n            setMovieHistory(newHistory);\r\n        } else if (movieHistory.length === 1) {\r\n            // Return to recommendations list\r\n            setMovieHistory([]);\r\n        }\r\n    };\r\n\r\n    // Movie card component\r\n    const MovieCard = ({ movie, isCompact }) => {\r\n        return (\r\n            <div className={isCompact ? styles.movieCardCompact : styles.movieCard} onClick={() => openMovie(movie)}>\r\n                <div className={styles.moviePosterContainer}>\r\n                    {movie.poster_url ? (\r\n                        <img src={movie.poster_url} alt={movie.title} className={styles.moviePoster} loading=\"lazy\" />\r\n                    ) : (\r\n                        <div className={styles.moviePosterPlaceholder}><p>Không có Poster</p></div>\r\n                    )}\r\n                    <div className={styles.playOverlay}>▶</div>\r\n                </div>\r\n                <div className={styles.movieDetails}>\r\n                    <h3 className={styles.movieTitle}>{movie.title} {movie.year > 0 && `(${movie.year})`}</h3>\r\n                    <p className={styles.rating}>⭐ {movie.vote_average || 'N/A'}/10</p>\r\n                    {!isCompact && <p className={styles.overview}>{movie.overview?.substring(0, 100)}...</p>}\r\n                </div>\r\n            </div>\r\n        );\r\n    };\r\n\r\n    const handleGetRecommendations = async () => {\r\n        setLoading(true);\r\n        setError('');\r\n        setRecommendations([]);\r\n\r\n        try {\r\n            // Fast-path: load from cache first to render immediately\r\n            const stored = localStorage.getItem('user');\r\n            const user = stored ? JSON.parse(stored) : null;\r\n            const cacheKey = `cached_recs_${recType}_${user && user.userId ? user.userId : 'public'}`;\r\n            try {\r\n                const raw = localStorage.getItem(cacheKey);\r\n                if (raw) {\r\n                    const parsed = JSON.parse(raw);\r\n                    const movies = parsed.results || [];\r\n                    if (movies.length > 0) {\r\n                        setRecommendations(movies);\r\n                        setLoading(false);\r\n                    }\r\n                }\r\n            } catch (e) {}\r\n\r\n            const userParam = user && user.userId ? `&user_id=${encodeURIComponent(user.userId)}` : '';\r\n            const url = `${API_BASE}/recommendations?rec_type=${encodeURIComponent(recType)}&n=10${userParam}`;\r\n            const response = await fetch(url);\r\n            if (!response.ok) {\r\n                const errorText = await response.text();\r\n                throw new Error(`Lỗi lấy gợi ý: ${response.status} - ${errorText.substring(0, 200)}`);\r\n            }\r\n            const data = await response.json();\r\n            const results = data.results || [];\r\n            // update UI and cache\r\n            setRecommendations(results);\r\n            try {\r\n                localStorage.setItem(cacheKey, JSON.stringify({ ts: Date.now(), results }));\r\n            } catch (e) {}\r\n            if (results.length === 0) setError('Không tìm thấy gợi ý nào.');\r\n        } catch (err) {\r\n            setError(`Thất bại khi kết nối: ${err.message}`);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    useEffect(() => { handleGetRecommendations(); }, []);\r\n\r\n    // Load YouTube IFrame API\r\n    useEffect(() => {\r\n        if (!window.YT) {\r\n            const tag = document.createElement('script');\r\n            tag.src = 'https://www.youtube.com/iframe_api';\r\n            const firstScriptTag = document.getElementsByTagName('script')[0];\r\n            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);\r\n        }\r\n    }, []);\r\n\r\n    // Auto-save progress every 10 seconds when playing\r\n    useEffect(() => {\r\n        if (!currentMovie || !player) return;\r\n        \r\n        const interval = setInterval(() => {\r\n            try {\r\n                if (player && typeof player.getCurrentTime === 'function' && typeof player.getDuration === 'function') {\r\n                    const currentTime = player.getCurrentTime();\r\n                    const duration = player.getDuration();\r\n                    if (currentTime > 0 && duration > 0) {\r\n                        saveVideoProgress(currentMovie.id, currentTime, duration);\r\n                    }\r\n                }\r\n            } catch (e) {\r\n                // Player might not be ready\r\n            }\r\n        }, 10000); // Save every 10 seconds\r\n        \r\n        return () => clearInterval(interval);\r\n    }, [currentMovie, player]);\r\n\r\n    // Save progress when user leaves page\r\n    useEffect(() => {\r\n        const handleBeforeUnload = () => {\r\n            if (currentMovie && player) {\r\n                try {\r\n                    const currentTime = player.getCurrentTime();\r\n                    const duration = player.getDuration();\r\n                    if (currentTime > 0) {\r\n                        saveVideoProgress(currentMovie.id, currentTime, duration);\r\n                    }\r\n                } catch (e) {}\r\n            }\r\n        };\r\n        \r\n        window.addEventListener('beforeunload', handleBeforeUnload);\r\n        return () => window.removeEventListener('beforeunload', handleBeforeUnload);\r\n    }, [currentMovie, player]);\r\n\r\n    return (\r\n        <div className={styles.mainContent}>\r\n            {!currentMovie ? (\r\n                <>\r\n                    <header className={styles.header}>\r\n                        <h1 className={styles.pageHeader}>⭐ Đề Xuất Phim Cho Bạn</h1>\r\n                    </header>\r\n\r\n                    {error && <div className={styles.error}>{error}</div>}\r\n                    {loading && recommendations.length === 0 && (\r\n                        <div className={styles.recommendationsContainer}>\r\n                            <div className={styles.skeletonTitle}></div>\r\n                            <div className={styles.movieRow}>\r\n                                {Array.from({length: 6}).map((_, i) => (\r\n                                    <div key={i} className={styles.movieCardSkeleton}>\r\n                                        <div className={styles.skeletonPoster}></div>\r\n                                        <div className={styles.skeletonText}></div>\r\n                                        <div className={styles.skeletonText} style={{width: '60%'}}></div>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {recommendations.length > 0 && (\r\n                        <div className={styles.recommendationsContainer}>\r\n                            <h2 className={styles.rowTitle}>🎬 Đề xuất hàng đầu ({recommendations.length})</h2>\r\n                            <div className={styles.movieRow}>\r\n                                {recommendations.map((movie, idx) => (<MovieCard key={idx} movie={movie} />))}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </>\r\n            ) : (\r\n                <div className={styles.moviePlayerContainer}>\r\n                    <button className={styles.backButton} onClick={goBack}>\r\n                        ← Quay lại\r\n                    </button>\r\n                    \r\n                    <div className={styles.playerSection}>\r\n                        <div className={styles.videoPlayer}>\r\n                            {(() => {\r\n                                const embed = currentMovie.video_url ? (getYouTubeEmbedUrl(currentMovie.video_url) || currentMovie.video_url) : null;\r\n                                const searchEmbed = embed ? isSearchEmbed(embed) : false;\r\n                                // If we have a proper embed and it's not a search-type embed, show iframe\r\n                                if (embed && !searchEmbed && embed.includes('/embed')) {\r\n                                    const sep = embed.includes('?') ? '&' : '?';\r\n                                    const savedProgress = videoProgress[currentMovie.id];\r\n                                    const startTime = savedProgress?.timestamp > 5 ? savedProgress.timestamp : 0;\r\n                                    const startParam = startTime > 0 ? `&start=${startTime}` : '';\r\n                                    \r\n                                    return (\r\n                                        <iframe\r\n                                            id={`youtube-player-${currentMovie.id}`}\r\n                                            width=\"100%\"\r\n                                            height=\"100%\"\r\n                                            title={currentMovie.title}\r\n                                            frameBorder=\"0\"\r\n                                            allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\"\r\n                                            allowFullScreen\r\n                                            referrerPolicy=\"strict-origin-when-cross-origin\"\r\n                                            src={`${embed}${sep}autoplay=1&mute=0&rel=0&modestbranding=1&enablejsapi=1${startParam}`}\r\n                                            onLoad={() => {\r\n                                                // Wait for YouTube IFrame API to be ready before initializing\r\n                                                const initPlayer = () => {\r\n                                                    if (window.YT && window.YT.Player) {\r\n                                                        try {\r\n                                                            const ytPlayer = new window.YT.Player(`youtube-player-${currentMovie.id}`, {\r\n                                                                events: {\r\n                                                                    'onReady': (event) => {\r\n                                                                        console.log('YouTube player ready');\r\n                                                                        setPlayer(event.target);\r\n                                                                        playerRef.current = event.target;\r\n                                                                        // Seek to saved position if available\r\n                                                                        if (startTime > 5) {\r\n                                                                            setTimeout(() => {\r\n                                                                                try {\r\n                                                                                    event.target.seekTo(startTime, true);\r\n                                                                                } catch (e) {\r\n                                                                                    console.warn('Failed to seek:', e);\r\n                                                                                }\r\n                                                                            }, 1000);\r\n                                                                        }\r\n                                                                        \r\n                                                                        // Auto-save progress every 10 seconds\r\n                                                                        const saveInterval = setInterval(() => {\r\n                                                                            try {\r\n                                                                                const player = playerRef.current;\r\n                                                                                if (player && typeof player.getCurrentTime === 'function') {\r\n                                                                                    const currentTime = player.getCurrentTime();\r\n                                                                                    const duration = player.getDuration();\r\n                                                                                    if (currentTime > 0) {\r\n                                                                                        saveVideoProgress(currentMovie.id, currentTime, duration);\r\n                                                                                    }\r\n                                                                                }\r\n                                                                            } catch (e) {}\r\n                                                                        }, 10000);\r\n                                                                        \r\n                                                                        // Clear interval when player is destroyed\r\n                                                                        return () => clearInterval(saveInterval);\r\n                                                                    },\r\n                                                                    'onStateChange': (event) => {\r\n                                                                        // Save when paused\r\n                                                                        if (event.data === window.YT.PlayerState.PAUSED) {\r\n                                                                            try {\r\n                                                                                const currentTime = event.target.getCurrentTime();\r\n                                                                                const duration = event.target.getDuration();\r\n                                                                                saveVideoProgress(currentMovie.id, currentTime, duration);\r\n                                                                            } catch (e) {}\r\n                                                                        }\r\n                                                                    }\r\n                                                                }\r\n                                                            });\r\n                                                        } catch (e) {\r\n                                                            console.warn('Failed to initialize YouTube player:', e);\r\n                                                        }\r\n                                                    } else {\r\n                                                        // YT API not ready yet, try again in 500ms\r\n                                                        setTimeout(initPlayer, 500);\r\n                                                    }\r\n                                                };\r\n                                                \r\n                                                // Start initialization with slight delay to ensure iframe is ready\r\n                                                setTimeout(initPlayer, 200);\r\n                                            }}\r\n                                        />\r\n                                    );\r\n                                }\r\n\r\n                                // Otherwise show poster with message + button to open YouTube search\r\n                                if (currentMovie.poster_url) {\r\n                                    return (\r\n                                        <div className={styles.noPoster}>\r\n                                            <img src={currentMovie.poster_url} alt={currentMovie.title} style={{width: '100%', height: '100%', objectFit: 'contain'}} />\r\n                                            <div className={styles.noVideoOverlay}>\r\n                                                {currentMovie.loadingTrailer ? 'Đang tải phim...' : 'Trailer không khả dụng'}\r\n                                            </div>\r\n                                            <div style={{position: 'absolute', right: 12, bottom: 12}}>\r\n                                                <button className={styles.openYouTubeBtn} onClick={() => window.open(currentMovie.video_url || `https://www.youtube.com/results?search_query=${encodeURIComponent(currentMovie.title || '')}`, '_blank')}>\r\n                                                    Mở trailer trên YouTube\r\n                                                </button>\r\n                                            </div>\r\n                                        </div>\r\n                                    );\r\n                                }\r\n\r\n                                return (\r\n                                    <div className={styles.noVideo}>\r\n                                        {currentMovie.loadingTrailer ? 'Đang tải phim...' : 'Không có trailer'}\r\n                                    </div>\r\n                                );\r\n                            })()}\r\n                        </div>\r\n                        \r\n                        <div className={styles.movieInfo}>\r\n                            <h1 className={styles.movieInfoTitle}>{currentMovie.title} {currentMovie.year > 0 && `(${currentMovie.year})`}</h1>\r\n                            <div className={styles.movieMeta}>\r\n                                <span className={styles.movieRating}>⭐ {currentMovie.vote_average || 'N/A'}/10</span>\r\n                                <span className={styles.movieVotes}>({currentMovie.vote_count || 0} votes)</span>\r\n                            </div>\r\n                            <p className={styles.movieDescription}>{currentMovie.overview}</p>\r\n\r\n                            {/* Like/Dislike/Watchlist/Review Buttons */}\r\n                            <div className={styles.interactionButtons}>\r\n                                <button \r\n                                    className={`${styles.likeBtn} ${likes[currentMovie.id] ? styles.active : ''}`}\r\n                                    onClick={handleLike}\r\n                                    title=\"Thích phim này\"\r\n                                >\r\n                                    👍 Thích\r\n                                </button>\r\n                                <button \r\n                                    className={`${styles.dislikeBtn} ${dislikes[currentMovie.id] ? styles.active : ''}`}\r\n                                    onClick={handleDislike}\r\n                                    title=\"Không thích\"\r\n                                >\r\n                                    👎 Không thích\r\n                                </button>\r\n                                <button \r\n                                    className={`${styles.watchlistBtn} ${watchlist[currentMovie.id] ? styles.active : ''}`}\r\n                                    onClick={handleWatchlist}\r\n                                    title={watchlist[currentMovie.id] ? \"Xóa khỏi danh sách\" : \"Lưu vào danh sách\"}\r\n                                >\r\n                                    {watchlist[currentMovie.id] ? '✓ Đã lưu' : '+ Lưu'}\r\n                                </button>\r\n                                <div className={styles.ratingInline}>\r\n                                    {[1,2,3,4,5].map(star => (\r\n                                        <button\r\n                                            key={star}\r\n                                            className={`${styles.star} ${(hoverRating || reviewRating) >= star ? styles.starActive : ''}`}\r\n                                            onClick={() => handleRate(star)}\r\n                                            onMouseEnter={() => setHoverRating(star)}\r\n                                            onMouseLeave={() => setHoverRating(0)}\r\n                                            title={`Đánh giá ${star} sao`}\r\n                                        >\r\n                                            ⭐\r\n                                        </button>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n                            {/* Comments section */}\r\n                            <div className={styles.commentsSection}>\r\n                                <h3>Bình luận</h3>\r\n                                <div className={styles.commentForm}>\r\n                                    <textarea value={commentText} onChange={(e) => setCommentText(e.target.value)} placeholder=\"Viết bình luận...\" rows={3} />\r\n                                    <button className={styles.submitBtn} onClick={handleSubmitComment}>Gửi</button>\r\n                                </div>\r\n                                <div className={styles.commentList}>\r\n                                    {comments.length === 0 && <div>Chưa có bình luận nào.</div>}\r\n                                    {comments.length > 0 && (\r\n                                        (showAllComments ? comments : comments.slice(0, 2)).map(c => (\r\n                                            <div key={c.id} className={styles.commentItem}>\r\n                                                <div className={styles.commentMeta}><strong>{c.display_name || c.userId}</strong> • <span className={styles.commentTime}>{new Date(c.timestamp).toLocaleString()}</span></div>\r\n                                                <div className={styles.commentText}>{c.comment}</div>\r\n                                            </div>\r\n                                        ))\r\n                                    )}\r\n\r\n                                    {comments.length > 2 && (\r\n                                        <div className={styles.commentToggle}>\r\n                                            <button className={styles.smallBtn} onClick={() => setShowAllComments(prev => !prev)}>\r\n                                                {showAllComments ? `Rút gọn` : `Xem thêm ${comments.length - 2} bình luận`}\r\n                                            </button>\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Review modal removed: replaced by quick star rating */}\r\n\r\n                    <div className={styles.similarMoviesSection}>\r\n                        <h2 className={styles.sectionTitle}>Gợi ý cho bạn</h2>\r\n                        {similarMovies.length > 0 ? (\r\n                            <div className={styles.similarMoviesGrid}>\r\n                                {similarMovies.map((movie, idx) => (\r\n                                    <MovieCard key={idx} movie={movie} isCompact={true} />\r\n                                ))}\r\n                            </div>\r\n                        ) : (\r\n                            <div className={styles.loadingMovies}>Đang tải...</div>\r\n                        )}\r\n                    </div>\r\n                    <div style={{marginTop: 12}}>\r\n                        <button className={styles.openYouTubeBtn} onClick={() => {\r\n                            const title = currentMovie?.title || '';\r\n                            const year = currentMovie?.year ? ` ${currentMovie.year}` : '';\r\n                            const query = encodeURIComponent(`${title}${year} trailer`);\r\n                            window.open(`https://www.youtube.com/results?search_query=${query}`, '_blank');\r\n                        }}>\r\n                            Mở trailer trên YouTube\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}